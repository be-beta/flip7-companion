<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>FLIP 7 · Companion</title>
  <link rel="icon" type="image/svg+xml" href="seven-icon.svg">
  <link rel="manifest" href="manifest.json">
  <link
    href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap"
    rel="stylesheet" />
  <style>
    /* ═══════════════════════════════════════════
   RESET + TOKENS
═══════════════════════════════════════════ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --gold: #F5C842;
      --gold2: #C89A10;
      --gold-glow: rgba(245, 200, 66, .3);
      --cream: #FDF6E3;
      --dark: #0A0A16;
      --dark2: #12121F;
      --dark3: #1A1A2E;
      --dark4: #222238;
      --red: #E8394A;
      --red2: #B02030;
      --teal: #3ECFCF;
      --blue: #4A7BD4;
      --green: #5CBD6A;
      --purple: #9B6BD4;
      --r: 14px;
      --r-sm: 10px;
      --r-lg: 20px;
    }

    html,
    body {
      height: 100%;
      background: var(--dark);
      color: var(--cream);
      font-family: 'DM Sans', sans-serif;
      overflow: hidden;
    }

    /* noise */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.03'/%3E%3C/svg%3E");
      pointer-events: none;
    }

    /* ═══════════════════════════════════════════
   LAYOUT
═══════════════════════════════════════════ */
    #app {
      position: relative;
      z-index: 1;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      overflow: hidden;
    }

    .screen {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    .screen.active {
      display: flex;
    }

    /* ═══════════════════════════════════════════
   TYPOGRAPHY
═══════════════════════════════════════════ */
    .bb {
      font-family: 'Bebas Neue', sans-serif;
      letter-spacing: .04em;
      line-height: 1;
    }

    /* ═══════════════════════════════════════════
   BUTTONS
═══════════════════════════════════════════ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      border: none;
      border-radius: var(--r);
      font-family: 'Bebas Neue', sans-serif;
      font-size: 18px;
      letter-spacing: .06em;
      cursor: pointer;
      transition: transform .12s, background .15s, box-shadow .15s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .btn:active {
      transform: scale(.95);
    }

    .btn-primary {
      background: var(--gold);
      color: var(--dark);
      width: 100%;
      box-shadow: 0 4px 24px var(--gold-glow);
    }

    .btn-primary:active {
      background: var(--gold2);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, .07);
      color: var(--cream);
      border: 1px solid rgba(255, 255, 255, .1);
    }

    .btn-ghost:active {
      background: rgba(255, 255, 255, .14);
    }

    .btn-danger {
      background: rgba(232, 57, 74, .15);
      color: var(--red);
      border: 1px solid rgba(232, 57, 74, .25);
    }

    .btn-teal {
      background: rgba(62, 207, 207, .15);
      color: var(--teal);
      border: 1px solid rgba(62, 207, 207, .25);
    }

    .btn-sm {
      padding: 10px 18px;
      font-size: 15px;
    }

    .btn-xs {
      padding: 7px 14px;
      font-size: 13px;
    }

    .btn-icon {
      padding: 0;
      width: 40px;
      height: 40px;
      border-radius: var(--r-sm);
      font-size: 16px;
    }

    .btn-full {
      width: 100%;
    }

    /* ═══════════════════════════════════════════
   INPUTS
═══════════════════════════════════════════ */
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 11px;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, .35);
    }

    input[type=text],
    input[type=number] {
      background: var(--dark3);
      border: 1.5px solid rgba(255, 255, 255, .1);
      border-radius: var(--r-sm);
      padding: 12px 16px;
      font-family: 'DM Sans', sans-serif;
      font-size: 16px;
      color: var(--cream);
      outline: none;
      transition: border-color .15s;
      -webkit-appearance: none;
      width: 100%;
    }

    input:focus {
      border-color: var(--gold);
    }

    input::placeholder {
      color: rgba(255, 255, 255, .2);
    }

    /* ═══════════════════════════════════════════
   BADGE / CHIP
═══════════════════════════════════════════ */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 9px;
      border-radius: 99px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .04em;
    }

    .badge-gold {
      background: rgba(245, 200, 66, .15);
      color: var(--gold);
    }

    .badge-red {
      background: rgba(232, 57, 74, .15);
      color: var(--red);
    }

    .badge-teal {
      background: rgba(62, 207, 207, .15);
      color: var(--teal);
    }

    .badge-green {
      background: rgba(92, 189, 106, .15);
      color: var(--green);
    }

    /* ═══════════════════════════════════════════
   AVATAR COLORS
═══════════════════════════════════════════ */
    .av-0 {
      background: rgba(232, 57, 74, .25);
      color: var(--red);
    }

    .av-1 {
      background: rgba(62, 207, 207, .25);
      color: var(--teal);
    }

    .av-2 {
      background: rgba(92, 189, 106, .25);
      color: var(--green);
    }

    .av-3 {
      background: rgba(74, 123, 212, .25);
      color: var(--blue);
    }

    .av-4 {
      background: rgba(245, 200, 66, .25);
      color: var(--gold);
    }

    .av-5 {
      background: rgba(155, 107, 212, .25);
      color: var(--purple);
    }

    /* ═══════════════════════════════════════════
   MODALS
═══════════════════════════════════════════ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0, 0, 0, .75);
      backdrop-filter: blur(8px);
      align-items: flex-end;
      justify-content: center;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-sheet {
      background: var(--dark2);
      border: 1px solid rgba(255, 255, 255, .1);
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-width: 480px;
      padding: 28px 22px calc(28px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      gap: 18px;
      animation: sheetUp .28s cubic-bezier(.22, 1, .36, 1) both;
      max-height: 90dvh;
      overflow-y: auto;
    }

    @keyframes sheetUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: none;
      }
    }

    .modal-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 26px;
      letter-spacing: .04em;
      color: var(--gold);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
    }

    /* ═══════════════════════════════════════════
   SCREEN: SPLASH
═══════════════════════════════════════════ */
    #screen-splash {
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      gap: 0;
    }

    .splash-flip {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(64px, 18vw, 88px);
      color: var(--gold);
      line-height: 1;
      text-shadow: 0 0 60px rgba(245, 200, 66, .2), 0 4px 0 var(--gold2);
      animation: dropIn .55s cubic-bezier(.22, 1, .36, 1) both;
    }

    .splash-seven {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(110px, 32vw, 150px);
      color: var(--gold);
      line-height: .85;
      text-shadow: 0 0 80px rgba(245, 200, 66, .25), 0 6px 0 var(--gold2);
      animation: dropIn .55s .08s cubic-bezier(.22, 1, .36, 1) both;
    }

    .splash-tag {
      font-size: 11px;
      letter-spacing: .2em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, .28);
      margin-top: 10px;
      animation: fadeUp .4s .28s both;
    }

    .splash-divider {
      width: 48px;
      height: 2px;
      background: var(--gold);
      opacity: .35;
      margin: 28px 0;
      animation: fadeUp .4s .32s both;
    }

    .splash-btns {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
      animation: fadeUp .4s .36s both;
    }

    /* Mode selector on splash */
    .mode-select {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .mode-card {
      flex: 1;
      background: var(--dark3);
      border: 1.5px solid rgba(255, 255, 255, .08);
      border-radius: var(--r);
      padding: 16px 12px;
      cursor: pointer;
      transition: all .18s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
    }

    .mode-card:hover,
    .mode-card:active {
      border-color: var(--gold);
      background: rgba(245, 200, 66, .07);
    }

    .mode-card.selected {
      border-color: var(--gold);
      background: rgba(245, 200, 66, .1);
    }

    .mode-card .mode-icon {
      font-size: 28px;
    }

    .mode-card .mode-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 17px;
      color: var(--gold);
      letter-spacing: .05em;
    }

    .mode-card .mode-desc {
      font-size: 11px;
      color: rgba(255, 255, 255, .35);
      line-height: 1.4;
    }

    .mode-card .mode-icon {
      font-size: 28px;
      transition: transform .1s;
    }

    .mode-card.selected .mode-icon.bolt {
      animation: pulseGlow 1.2s ease-in-out infinite alternate;
    }

    @keyframes pulseGlow {
      from {
        transform: scale(1);
        text-shadow: 0 0 10px rgba(245, 200, 66, 0.4);
      }

      to {
        transform: scale(1.15);
        text-shadow: 0 0 25px rgba(245, 200, 66, 0.8), 0 0 40px rgba(245, 200, 66, 0.4);
      }
    }

    @keyframes dropIn {
      from {
        opacity: 0;
        transform: translateY(28px) scale(.9);
      }

      to {
        opacity: 1;
        transform: none;
      }
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(14px);
      }

      to {
        opacity: 1;
        transform: none;
      }
    }

    /* ═══════════════════════════════════════════
   SCREEN: SETUP (shared)
═══════════════════════════════════════════ */
    #screen-setup {
      overflow-y: auto;
      padding: 0 20px calc(20px + env(safe-area-inset-bottom));
      gap: 22px;
    }

    .setup-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 18px 0 0;
    }

    .logo-mark {
      width: 42px;
      height: 42px;
      background: var(--gold);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 20px;
      color: var(--dark);
      box-shadow: 0 2px 14px var(--gold-glow);
      flex-shrink: 0;
    }

    .header-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 21px;
      color: var(--gold);
      letter-spacing: .05em;
      line-height: 1;
    }

    .header-sub {
      font-size: 11px;
      color: rgba(255, 255, 255, .3);
      letter-spacing: .08em;
      text-transform: uppercase;
    }

    .section-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 19px;
      color: var(--gold);
      letter-spacing: .05em;
    }

    .player-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .player-row {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--dark3);
      border: 1px solid rgba(255, 255, 255, .07);
      border-radius: 12px;
      padding: 4px 4px 4px 14px;
      animation: slideIn .18s cubic-bezier(.22, 1, .36, 1) both;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }

      to {
        opacity: 1;
        transform: none;
      }
    }

    .player-row .p-num {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 20px;
      color: var(--gold);
      opacity: .4;
      min-width: 18px;
    }

    .player-row input {
      flex: 1;
      background: transparent;
      border: none;
      padding: 10px 0;
      font-family: 'DM Sans', sans-serif;
      font-size: 16px;
      color: var(--cream);
      outline: none;
      width: auto;
    }

    .player-row input::placeholder {
      color: rgba(255, 255, 255, .2);
    }

    /* drag handle */
    .drag-handle {
      display: flex;
      flex-direction: column;
      gap: 3px;
      padding: 10px 10px 10px 4px;
      cursor: grab;
      opacity: .3;
      flex-shrink: 0;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .drag-handle span {
      display: block;
      width: 16px;
      height: 2px;
      background: var(--cream);
      border-radius: 2px;
    }

    .player-row.drag-over {
      border-color: var(--gold);
      background: rgba(245, 200, 66, .06);
    }

    .player-row.dragging {
      opacity: .4;
      transform: scale(.97);
    }

    /* editable name in game */
    .edit-name-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, .18);
      font-size: 12px;
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 4px;
      transition: all .15s;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }

    .edit-name-btn:active {
      color: var(--gold);
    }

    /* hand card removable */
    .hand-card {
      cursor: pointer;
    }

    .hand-card:active {
      transform: scale(.88) !important;
    }

    .s-hand-card {
      cursor: pointer;
    }

    .s-hand-card:active {
      transform: scale(.88);
    }

    /* edit modal */
    #edit-name-input {
      font-size: 18px;
      text-align: center;
    }

    .add-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 16px;
      background: rgba(255, 255, 255, .03);
      border: 1.5px dashed rgba(255, 255, 255, .1);
      border-radius: 12px;
      color: rgba(255, 255, 255, .3);
      font-size: 14px;
      cursor: pointer;
      transition: all .15s;
    }

    .add-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .meta-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .meta-chip {
      padding: 9px 18px;
      border-radius: 99px;
      border: 1.5px solid rgba(255, 255, 255, .1);
      background: transparent;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 17px;
      color: rgba(255, 255, 255, .4);
      cursor: pointer;
      transition: all .15s;
    }

    .meta-chip.on {
      background: var(--gold);
      color: var(--dark);
      border-color: var(--gold);
      box-shadow: 0 2px 14px var(--gold-glow);
    }

    .mode-badge-row {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--dark3);
      border-radius: 12px;
      padding: 12px 16px;
    }

    .mode-badge-icon {
      font-size: 22px;
    }

    .mode-badge-info {
      flex: 1;
    }

    .mode-badge-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 16px;
      color: var(--gold);
      letter-spacing: .04em;
    }

    .mode-badge-desc {
      font-size: 12px;
      color: rgba(255, 255, 255, .35);
    }

    /* ═══════════════════════════════════════════
   SCREEN: SIMPLE GAME
═══════════════════════════════════════════ */
    #screen-simple {
      overflow: hidden;
    }

    /* toggle manual/cards */
    .input-mode-toggle {
      display: flex;
      background: var(--dark3);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .08);
      padding: 0;
    }

    .imt-btn {
      flex: 1;
      text-align: center;
      padding: 10px 18px;
      font-size: 11px;
      color: rgba(255, 255, 255, .4);
      cursor: pointer;
      min-width: 74px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }

    .imt-btn.on {
      background: var(--gold);
      color: var(--dark);
      font-weight: 600;
    }

    /* round info bar */
    .round-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--dark2);
      border-bottom: 1px solid rgba(255, 255, 255, .05);
      flex-shrink: 0;
    }

    .round-label-wrapper {
      flex: 1;
      display: flex;
      justify-content: flex-start;
    }

    .round-meta-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .toggle-wrapper {
      flex: 1;
      display: flex;
      justify-content: flex-end;
    }

    .round-label {
      font-size: 20px;
      color: var(--teal);
      letter-spacing: .06em;
    }

    .round-meta {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .scoreboard-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* score card simple */
    .ssc {
      background: var(--dark2);
      border: 1.5px solid rgba(255, 255, 255, .07);
      border-radius: var(--r);
      overflow: hidden;
      transition: border-color .2s;
      flex-shrink: 0;
    }

    .ssc.leading {
      border-color: rgba(245, 200, 66, .35);
    }

    .ssc.near {
      border-color: rgba(232, 57, 74, .3);
    }

    .ssc-top {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
    }

    .ssc-av {
      width: 34px;
      height: 34px;
      border-radius: 99px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 16px;
      flex-shrink: 0;
    }

    .ssc-name {
      font-weight: 600;
      font-size: 14px;
      flex: 1;
    }

    .ssc-total {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 30px;
      color: var(--gold);
      line-height: 1;
    }

    .ssc-bar {
      height: 3px;
      background: rgba(255, 255, 255, .06);
    }

    .ssc-fill {
      height: 100%;
      background: var(--gold);
      transition: width .45s cubic-bezier(.22, 1, .36, 1);
    }

    .ssc-fill.danger {
      background: var(--red);
    }

    .ssc-input {
      padding: 10px 14px 14px;
      border-top: 1px solid rgba(255, 255, 255, .05);
    }

    .ssc-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ssc-lbl {
      font-size: 11px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, .3);
      white-space: nowrap;
    }

    .num-input {
      flex: 1;
      background: var(--dark3);
      border: 1.5px solid rgba(255, 255, 255, .1);
      border-radius: 9px;
      padding: 8px 10px;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      color: var(--cream);
      text-align: center;
      outline: none;
      transition: border-color .15s;
      -webkit-appearance: none;
    }

    .num-input:focus {
      border-color: var(--gold);
    }

    .step-btn {
      width: 36px;
      height: 36px;
      border-radius: 9px;
      border: 1.5px solid rgba(255, 255, 255, .1);
      background: var(--dark3);
      color: var(--cream);
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .1s;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
    }

    .step-btn:active {
      transform: scale(.88);
    }

    .bust-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      cursor: pointer;
    }

    .bust-box {
      width: 20px;
      height: 20px;
      border-radius: 5px;
      border: 1.5px solid rgba(255, 255, 255, .15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      transition: all .12s;
    }

    .bust-row.on .bust-box {
      background: var(--red);
      border-color: var(--red);
    }

    .bust-lbl {
      font-size: 12px;
      color: rgba(255, 255, 255, .35);
    }

    .bust-row.on .bust-lbl {
      color: var(--red);
    }

    .hist-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      padding: 0 14px 10px;
    }

    .hc {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(255, 255, 255, .07);
      color: rgba(255, 255, 255, .4);
    }

    .hc.bust {
      background: rgba(232, 57, 74, .15);
      color: var(--red);
    }

    .hc.flip7 {
      background: rgba(245, 200, 66, .15);
      color: var(--gold);
    }

    /* simple mode: cards vs manual toggle */
    .input-mode-toggle {
      display: flex;
      gap: 0;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .1);
      flex-shrink: 0;
    }

    .imt-btn {
      flex: 1;
      padding: 6px 0;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all .15s;
      color: rgba(255, 255, 255, .35);
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }

    .imt-btn.on {
      background: var(--gold);
      color: var(--dark);
    }

    /* simple hand display */
    .s-hand {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 0 0 8px;
      min-height: 36px;
    }

    .s-hand-card {
      width: 34px;
      height: 50px;
      border-radius: 6px;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--dark3);
      color: var(--cream);
      border: 1.5px solid rgba(255, 255, 255, .18);
      cursor: pointer;
      flex-shrink: 0;
    }

    .s-hand-card:active {
      transform: scale(.88);
    }

    .s-hand-card.mod {
      background: rgba(245, 200, 66, .12);
      color: var(--gold);
      border-color: rgba(245, 200, 66, .3);
      font-size: 11px;
      text-align: center;
      line-height: 1.1;
      padding: 2px;
    }

    /* small pick grid for simple mode */
    .s-pick-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 4px;
    }

    .s-pick-mod-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
    }

    .spc {
      aspect-ratio: 2/3;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 15px;
      border: 1.5px solid rgba(255, 255, 255, .1);
      background: var(--dark3);
      color: var(--cream);
      cursor: pointer;
      transition: all .12s;
      -webkit-tap-highlight-color: transparent;
    }

    .spc:active {
      transform: scale(.88);
    }

    .spc.rep {
      border-color: rgba(245, 200, 66, .4);
      color: var(--gold);
    }

    .spc.gone {
      opacity: .18;
      pointer-events: none;
    }

    .spc .sc-cnt {
      font-size: 7px;
      color: rgba(255, 255, 255, .25);
      font-family: 'DM Sans', sans-serif;
    }

    .spm {
      padding: 8px 2px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 14px;
      border: 1.5px solid rgba(255, 255, 255, .1);
      background: var(--dark3);
      color: var(--gold);
      cursor: pointer;
      transition: all .12s;
      -webkit-tap-highlight-color: transparent;
    }

    .spm:active {
      transform: scale(.88);
    }

    .spm.gone {
      opacity: .18;
      pointer-events: none;
    }

    .game-bottom {
      padding: 12px 18px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      border-top: 1px solid rgba(255, 255, 255, .06);
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }

    /* ═══════════════════════════════════════════
   SCREEN: DYNAMIC GAME
═══════════════════════════════════════════ */
    #screen-dynamic {
      overflow: hidden;
      position: relative;
    }

    /* mini scoreboard strip */
    .mini-scores {
      display: flex;
      gap: 6px;
      padding: 12px 16px 8px;
      overflow-x: auto;
      flex-shrink: 0;
      scrollbar-width: none;
    }

    .mini-scores::-webkit-scrollbar {
      display: none;
    }

    .mini-player {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 52px;
      padding: 8px 6px;
      border-radius: 10px;
      border: 1.5px solid rgba(255, 255, 255, .07);
      background: var(--dark2);
      transition: all .2s;
      position: relative;
    }

    .mini-player.active-turn {
      border-color: var(--gold);
      background: rgba(245, 200, 66, .08);
      box-shadow: 0 0 16px rgba(245, 200, 66, .15);
    }

    .mini-player.stayed {
      opacity: .5;
    }

    .mini-player.busted {
      opacity: .35;
    }

    .mini-player.frozen {
      opacity: .55;
      border-color: rgba(62, 207, 207, .3);
    }

    .mini-av {
      width: 28px;
      height: 28px;
      border-radius: 99px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 13px;
      flex-shrink: 0;
    }

    .mini-name {
      font-size: 10px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 48px;
      text-align: center;
    }

    .mini-score {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 16px;
      color: var(--gold);
    }

    .mini-status {
      position: absolute;
      top: -4px;
      right: -4px;
      font-size: 11px;
      line-height: 1;
    }

    /* active player zone */
    .active-zone {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0 16px;
      overflow-y: auto;
    }

    .turn-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0 6px;
    }

    .turn-av {
      width: 44px;
      height: 44px;
      border-radius: 99px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 20px;
      flex-shrink: 0;
    }

    .turn-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 28px;
      color: var(--cream);
      letter-spacing: .03em;
      flex: 1;
    }

    .turn-pts {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 28px;
      color: var(--gold);
    }

    /* hand display */
    .hand-area {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 6px 0 10px;
      min-height: 50px;
    }

    .hand-card {
      width: 36px;
      height: 54px;
      border-radius: 7px;
      font-family: 'Bebas Neue', sans-serif;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1px;
      flex-shrink: 0;
      animation: cardPop .2s cubic-bezier(.22, 1, .36, 1) both;
    }

    @keyframes cardPop {
      from {
        opacity: 0;
        transform: scale(.6) rotate(-6deg);
      }

      to {
        opacity: 1;
        transform: none;
      }
    }

    .hand-card.num {
      font-size: 18px;
      background: var(--dark3);
      color: var(--cream);
      border: 1.5px solid rgba(255, 255, 255, .2);
    }

    .hand-card.num-zero {
      font-size: 13px;
      background: rgba(255, 255, 255, .05);
      color: rgba(255, 255, 255, .4);
      border: 1.5px solid rgba(255, 255, 255, .12);
    }

    .hand-card.mod {
      font-size: 11px;
      background: rgba(245, 200, 66, .15);
      color: var(--gold);
      border: 1.5px solid rgba(245, 200, 66, .3);
      text-align: center;
      line-height: 1.1;
    }

    .hand-card.mod.x2 {
      background: rgba(62, 207, 207, .15);
      color: var(--teal);
      border-color: rgba(62, 207, 207, .3);
    }

    .hand-card.sc {
      font-size: 9px;
      background: rgba(92, 189, 106, .12);
      color: var(--green);
      border: 1.5px solid rgba(92, 189, 106, .25);
      text-align: center;
      line-height: 1.1;
      padding: 2px;
    }

    .section-lbl {
      font-size: 11px;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, .3);
      margin-bottom: 2px;
    }

    /* action buttons */
    .action-btns {
      display: flex;
      gap: 10px;
      padding: 6px 0 12px;
    }

    .btn-hit {
      flex: 1;
      background: var(--gold);
      color: var(--dark);
      font-family: 'Bebas Neue', sans-serif;
      font-size: 26px;
      letter-spacing: .06em;
      border: none;
      border-radius: var(--r);
      padding: 18px;
      cursor: pointer;
      box-shadow: 0 4px 28px var(--gold-glow);
      transition: all .12s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-hit:active {
      transform: scale(.95);
      background: var(--gold2);
    }

    .btn-stay {
      flex: 0 0 auto;
      background: rgba(255, 255, 255, .07);
      color: var(--cream);
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      letter-spacing: .05em;
      border: 1px solid rgba(255, 255, 255, .1);
      border-radius: var(--r);
      padding: 18px 24px;
      cursor: pointer;
      transition: all .12s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-stay:active {
      transform: scale(.95);
    }

    /* second chance indicator */
    .sc-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(92, 189, 106, .1);
      border: 1px solid rgba(92, 189, 106, .2);
      margin-bottom: 8px;
    }

    .sc-icon {
      font-size: 18px;
    }

    .sc-text {
      font-size: 12px;
      color: var(--green);
      font-weight: 500;
    }

    /* dyn bottom */
    .dyn-bottom {
      padding: 10px 16px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      border-top: 1px solid rgba(255, 255, 255, .06);
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    /* ── INLINE CARD PICKER (dynamic screen) ── */
    .inline-picker {
      flex-shrink: 0;
      border-top: 1px solid rgba(255, 255, 255, .06);
      background: var(--dark2);
      padding: 10px 14px 12px;
      height: 250px;
      display: flex;
      flex-direction: column;
    }

    #ip-content {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 20px;
      /* Extra room so it's not strictly tight */
    }

    .ip-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }

    .ip-tab {
      flex: 1;
      padding: 7px 4px;
      border-radius: 8px;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 13px;
      letter-spacing: .04em;
      border: 1.5px solid rgba(255, 255, 255, .08);
      background: transparent;
      color: rgba(255, 255, 255, .35);
      cursor: pointer;
      transition: all .15s;
      text-align: center;
    }

    .ip-tab.on {
      background: var(--gold);
      color: var(--dark);
      border-color: var(--gold);
    }

    .ip-grid-nums {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .ip-grid-mods {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
    }

    .ip-grid-acts {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
    }

    .ip-card {
      aspect-ratio: 2/3;
      border-radius: 7px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 17px;
      border: 1.5px solid rgba(255, 255, 255, .1);
      background: var(--dark3);
      color: var(--cream);
      cursor: pointer;
      transition: all .14s;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      gap: 0;
    }

    .ip-card:active {
      transform: scale(.88);
    }

    .ip-card.rep {
      border-color: rgba(245, 200, 66, .5);
      background: rgba(245, 200, 66, .07);
      color: var(--gold);
    }

    .ip-card.gone {
      opacity: .18;
      pointer-events: none;
    }

    .ip-card .cnt {
      font-size: 8px;
      color: rgba(255, 255, 255, .3);
      letter-spacing: 0;
      font-family: 'DM Sans', sans-serif;
      line-height: 1;
    }

    /* mods e actions também no formato carta */
    .ip-mod {
      aspect-ratio: 2/3;
      border-radius: 7px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 14px;
      border: 1.5px solid rgba(245, 200, 66, .3);
      background: rgba(245, 200, 66, .08);
      color: var(--gold);
      cursor: pointer;
      transition: all .14s;
      -webkit-tap-highlight-color: transparent;
      text-align: center;
      line-height: 1.1;
    }

    .ip-mod:active {
      transform: scale(.88);
    }

    .ip-mod.x2 {
      color: var(--teal);
      border-color: rgba(62, 207, 207, .3);
      background: rgba(62, 207, 207, .08);
    }

    .ip-mod.gone {
      opacity: .18;
      pointer-events: none;
    }

    /* ── CARD PICKER MODAL ──────────────────────── */
    #modal-pick .modal-sheet {
      gap: 14px;
    }

    .pick-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 24px;
      letter-spacing: .04em;
      color: var(--gold);
    }

    .pick-tabs {
      display: flex;
      gap: 6px;
    }

    .pick-tab {
      flex: 1;
      padding: 9px 6px;
      border-radius: 9px;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 14px;
      letter-spacing: .04em;
      border: 1.5px solid rgba(255, 255, 255, .1);
      background: transparent;
      color: rgba(255, 255, 255, .4);
      cursor: pointer;
      transition: all .15s;
      text-align: center;
    }

    .pick-tab.on {
      background: var(--gold);
      color: var(--dark);
      border-color: var(--gold);
    }

    .pick-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 7px;
    }

    .pick-card {
      aspect-ratio: 2/3;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      border: 1.5px solid rgba(255, 255, 255, .1);
      background: var(--dark3);
      color: var(--cream);
      cursor: pointer;
      transition: all .15s;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }

    .pick-card:active {
      transform: scale(.92);
    }

    .pick-card.available {
      border-color: rgba(255, 255, 255, .25);
    }

    .pick-card.taken {
      opacity: .2;
      cursor: not-allowed;
      background: rgba(0, 0, 0, .2);
    }

    .pick-card.highlight {
      border-color: var(--gold);
      box-shadow: 0 0 12px rgba(245, 200, 66, .3);
    }

    .pick-card .card-count {
      position: absolute;
      top: 3px;
      right: 4px;
      font-size: 9px;
      color: rgba(255, 255, 255, .4);
      letter-spacing: 0;
    }

    /* modifier picks */
    .pick-mod-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .pick-mod {
      padding: 14px 8px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 20px;
      border: 1.5px solid rgba(255, 255, 255, .1);
      background: var(--dark3);
      color: var(--gold);
      cursor: pointer;
      transition: all .15s;
      -webkit-tap-highlight-color: transparent;
    }

    .pick-mod:active {
      transform: scale(.9);
    }

    .pick-mod.x2 {
      color: var(--teal);
      border-color: rgba(62, 207, 207, .2);
    }

    .pick-mod.taken {
      opacity: .2;
      cursor: not-allowed;
    }

    /* action picks */
    .pick-action-grid {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 8px;
    }

    .pick-action {
      padding: 14px 16px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 14px;
      border: 1.5px solid rgba(255, 255, 255, .1);
      background: var(--dark3);
      cursor: pointer;
      transition: all .15s;
      -webkit-tap-highlight-color: transparent;
    }

    .pick-action:active {
      transform: scale(.97);
    }

    .pick-action .pa-icon {
      font-size: 26px;
      flex-shrink: 0;
    }

    .pick-action .pa-info {
      flex: 1;
    }

    .pick-action .pa-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 18px;
      color: var(--cream);
      letter-spacing: .04em;
    }

    .pick-action .pa-desc {
      font-size: 12px;
      color: rgba(255, 255, 255, .35);
    }

    .pick-action.taken {
      opacity: .25;
      cursor: not-allowed;
    }

    /* ── FREEZE TARGET MODAL ────────────────────── */
    .freeze-targets {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .freeze-target {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 12px;
      background: var(--dark3);
      border: 1.5px solid rgba(255, 255, 255, .1);
      cursor: pointer;
      transition: all .15s;
      -webkit-tap-highlight-color: transparent;
    }

    .freeze-target:active {
      border-color: var(--teal);
      background: rgba(62, 207, 207, .08);
    }

    .ft-av {
      width: 36px;
      height: 36px;
      border-radius: 99px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 16px;
    }

    .ft-name {
      font-weight: 600;
      flex: 1;
    }

    .ft-pts {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      color: var(--gold);
    }

    /* ── FLIP THREE BANNER SLOTS ────────────────── */
    .f3b-slot {
      width: 32px;
      height: 46px;
      border-radius: 6px;
      background: var(--dark3);
      border: 1.5px solid rgba(62, 207, 207, .2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 13px;
      color: rgba(255, 255, 255, .25);
      transition: all .25s;
    }

    .f3b-slot.done {
      border-color: var(--gold);
      background: rgba(245, 200, 66, .12);
      color: var(--gold);
      animation: cardPop .2s cubic-bezier(.22, 1, .36, 1);
    }

    .f3b-slot.bust {
      border-color: var(--red);
      background: rgba(232, 57, 74, .1);
      color: var(--red);
      font-size: 9px;
    }

    /* ── ACTION CARDS IN PICKER (bigger, full names) ── */
    .ip-act {
      aspect-ratio: 2/3;
      border-radius: 7px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      border: 1.5px solid rgba(255, 255, 255, .14);
      background: var(--dark3);
      cursor: pointer;
      transition: all .14s;
      -webkit-tap-highlight-color: transparent;
      padding: 4px;
    }

    .ip-act:active {
      transform: scale(.88);
    }

    .ip-act .ia-icon {
      font-size: 24px;
      line-height: 1;
    }

    .ip-act .ia-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 11px;
      color: var(--cream);
      letter-spacing: .03em;
      text-align: center;
      line-height: 1.2;
    }

    .ip-act.gone {
      opacity: .2;
      pointer-events: none;
    }

    /* ── BUST OVERLAY ───────────────────────────── */
    #bust-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 400;
      background: var(--red2);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      padding: 24px;
      animation: bustIn .2s ease both;
    }

    #bust-overlay.open {
      display: flex;
    }

    @keyframes bustIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .bust-name-big {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(52px, 14vw, 72px);
      color: #fff;
      letter-spacing: .03em;
      text-align: center;
      line-height: 1;
    }

    .bust-word {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(72px, 20vw, 96px);
      color: #fff;
      text-shadow: 0 0 40px rgba(255, 255, 255, .4);
      animation: shakeX .4s .1s both;
      line-height: 1;
    }

    @keyframes shakeX {

      0%,
      100% {
        transform: none;
      }

      15% {
        transform: translateX(-12px) rotate(-3deg);
      }

      30% {
        transform: translateX(12px) rotate(3deg);
      }

      45% {
        transform: translateX(-8px);
      }

      60% {
        transform: translateX(8px);
      }

      75% {
        transform: translateX(-4px);
      }
    }

    .bust-sub {
      font-size: 14px;
      color: rgba(255, 255, 255, .6);
      text-align: center;
    }

    .bust-tap {
      font-size: 12px;
      color: rgba(255, 255, 255, .35);
      text-align: center;
      margin-top: 16px;
      letter-spacing: .1em;
      text-transform: uppercase;
      animation: breathe 1.5s ease-in-out infinite;
    }

    @keyframes breathe {

      0%,
      100% {
        opacity: .35;
      }

      50% {
        opacity: .7;
      }
    }

    /* ── FLIP7 OVERLAY ──────────────────────────── */
    #flip7-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 400;
      background: linear-gradient(135deg, #1a1200, #2a1f00);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
      padding: 24px;
    }

    #flip7-overlay.open {
      display: flex;
    }

    .f7-stars {
      font-size: 36px;
      animation: spin .8s ease both;
    }

    @keyframes spin {
      from {
        transform: rotate(-30deg) scale(.5);
        opacity: 0;
      }

      to {
        transform: none;
        opacity: 1;
      }
    }

    .f7-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(42px, 12vw, 60px);
      color: var(--gold);
      text-align: center;
      line-height: 1;
      animation: fadeUp .35s .15s both;
    }

    .f7-word {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(64px, 18vw, 84px);
      color: var(--gold);
      text-shadow: 0 0 60px var(--gold-glow);
      animation: fadeUp .35s .2s both;
      line-height: 1;
    }

    .f7-bonus {
      font-size: 18px;
      color: rgba(255, 255, 255, .5);
      animation: fadeUp .35s .3s both;
    }

    .f7-tap {
      font-size: 12px;
      color: rgba(255, 255, 255, .3);
      margin-top: 20px;
      letter-spacing: .1em;
      text-transform: uppercase;
      animation: breathe 1.5s ease-in-out infinite;
    }

    /* ── ROUND END CONFIRM ──────────────────────── */
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: var(--dark3);
      border-radius: 10px;
    }

    .sum-name {
      font-weight: 500;
      font-size: 14px;
    }

    .sum-pts {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      color: var(--gold);
    }

    .sum-pts.bust {
      color: var(--red);
    }

    .sum-pts.zero {
      color: rgba(255, 255, 255, .3);
    }

    /* ═══════════════════════════════════════════
   SCREEN: WINNER
═══════════════════════════════════════════ */
    #screen-winner {
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      gap: 0;
      text-align: center;
      overflow-y: auto;
    }

    .w-trophy {
      font-size: 64px;
      animation: bounceIn .5s cubic-bezier(.22, 1, .36, 1) both;
    }

    .w-label {
      font-size: 11px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, .3);
      margin-top: 22px;
      animation: fadeUp .4s .12s both;
    }

    .w-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(48px, 13vw, 68px);
      color: var(--gold);
      letter-spacing: .03em;
      line-height: 1.05;
      animation: fadeUp .4s .18s both;
    }

    .w-pts {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 26px;
      color: rgba(255, 255, 255, .3);
      animation: fadeUp .4s .22s both;
    }

    .w-table {
      width: 100%;
      margin-top: 28px;
      display: flex;
      flex-direction: column;
      gap: 7px;
      animation: fadeUp .4s .28s both;
    }

    .w-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 10px;
    }

    .w-row:first-child {
      background: rgba(245, 200, 66, .1);
    }

    .w-rank {
      font-size: 18px;
      width: 28px;
      text-align: center;
    }

    .w-rname {
      font-weight: 600;
      flex: 1;
      text-align: left;
    }

    .w-rpts {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      color: var(--gold);
    }

    .w-actions {
      width: 100%;
      margin-top: 28px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      animation: fadeUp .4s .34s both;
    }

    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(.3) rotate(-10deg);
      }

      65% {
        transform: scale(1.18) rotate(4deg);
      }

      100% {
        opacity: 1;
        transform: none;
      }
    }

    /* ═══════════════════════════════════════════
   CANVAS
═══════════════════════════════════════════ */
    #confetti-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 100;
    }

    /* ═══════════════════════════════════════════
   UTILS
═══════════════════════════════════════════ */
    .mt-auto {
      margin-top: auto;
    }

    .divider {
      height: 1px;
      background: rgba(255, 255, 255, .06);
    }

    .flex-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .flex-1 {
      flex: 1;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <canvas id="confetti-canvas"></canvas>

  <!-- BUST OVERLAY -->
  <div id="bust-overlay" onclick="Dyn.dismissBust()">
    <div class="bust-name-big" id="bust-player-name">FULANO</div>
    <div class="bust-word">BUST!</div>
    <div class="bust-sub" id="bust-card-info">Tirou um número repetido</div>
    <div class="bust-tap">Toque para continuar</div>
  </div>

  <!-- FLIP7 OVERLAY -->
  <div id="flip7-overlay" onclick="Dyn.dismissFlip7()">
    <div class="f7-stars">✦ ✦ ✦</div>
    <div class="f7-name" id="f7-player-name">FULANO</div>
    <div class="f7-word">FLIP 7!</div>
    <div class="f7-bonus">+15 pontos bônus</div>
    <div class="f7-tap">Toque para continuar</div>
  </div>

  <!-- FLIP THREE OVERLAY removed — now uses inline banner -->


  <div id="app">

    <!-- ══════════════════ SPLASH ══════════════════ -->
    <div id="screen-splash" class="screen active">
      <div class="splash-flip bb">FLIP</div>
      <div class="splash-seven bb">7</div>
      <div class="splash-tag">Companion App</div>
      <div class="splash-divider"></div>

      <div class="mode-select" id="mode-select">
        <div class="mode-card selected" data-mode="simple" onclick="UI.pickMode('simple',this)">
          <div class="mode-icon">📝</div>
          <div class="mode-name">SIMPLES</div>
          <div class="mode-desc">Digite pontos manualmente por rodada</div>
        </div>
        <div class="mode-card" data-mode="dynamic" onclick="UI.pickMode('dynamic',this)">
          <div class="mode-icon bolt" id="bolt-icon">⚡</div>
          <div class="mode-name">DINÂMICO</div>
          <div class="mode-desc">Selecione as cartas • Turno a turno</div>
        </div>
      </div>

      <div class="splash-divider" style="margin:20px 0;"></div>

      <div class="splash-btns">
        <button class="btn btn-primary" onclick="UI.goSetup()">✦ NOVA PARTIDA</button>
        <button class="btn btn-ghost" id="btn-continue" style="display:none" onclick="UI.continueGame()">↩ CONTINUAR
          PARTIDA</button>
      </div>
      <p style="text-align:center;margin-top:18px;font-size:11px;
    color:rgba(255,255,255,.2);letter-spacing:.06em;">
        100% OFFLINE · SEM CONTA · SEM ADS
      </p>
    </div>

    <!-- ══════════════════ SETUP ══════════════════ -->
    <div id="screen-setup" class="screen">
      <div class="setup-header">
        <div class="logo-mark">F7</div>
        <div>
          <div class="header-title">Nova Partida</div>
          <div class="header-sub">Configuração</div>
        </div>
      </div>

      <!-- selected mode badge -->
      <div class="mode-badge-row" id="setup-mode-badge">
        <div class="mode-badge-icon" id="smb-icon">📝</div>
        <div class="mode-badge-info">
          <div class="mode-badge-name" id="smb-name">MODO SIMPLES</div>
          <div class="mode-badge-desc" id="smb-desc">Pontuação manual por rodada</div>
        </div>
        <button class="btn btn-ghost btn-xs" onclick="UI.backToSplash()">Mudar</button>
      </div>

      <div>
        <div class="section-title" style="margin-bottom:10px">Jogadores</div>
        <div class="player-list" id="player-list"></div>
        <div class="add-btn" id="add-player-btn" onclick="UI.addPlayer()">
          <span style="font-size:18px">＋</span> Adicionar jogador
        </div>
      </div>

      <div>
        <div class="section-title" style="margin-bottom:10px">Meta de Pontos</div>
        <div class="meta-chips" id="meta-chips">
          <div class="meta-chip on" data-v="200" onclick="UI.setMeta(200,this)">200</div>
          <div class="meta-chip" data-v="300" onclick="UI.setMeta(300,this)">300</div>
          <div class="meta-chip" data-v="500" onclick="UI.setMeta(500,this)">500</div>
          <div class="meta-chip" data-v="c" onclick="UI.setMeta('c',this)">Outro</div>
        </div>
        <div id="custom-meta" style="margin-top:10px;display:none">
          <input type="number" id="custom-meta-val" placeholder="Ex: 150" min="50" max="9999"
            oninput="G.state.meta=parseInt(this.value)||200" />
        </div>
      </div>

      <div class="mt-auto" style="padding-top:8px">
        <div id="setup-difficulty" style="display:none;margin-bottom:14px;">
          <div class="section-title" style="margin-bottom:6px;font-size:16px;">Dificuldade</div>
          <div style="display:flex;gap:8px;">
            <div class="meta-chip on" id="diff-easy" onclick="UI.setDiff('easy',this)">🟢 Fácil</div>
            <div class="meta-chip" id="diff-hard" onclick="UI.setDiff('hard',this)">🔴 Difícil</div>
          </div>
          <div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:6px;line-height:1.5;">
            <b style="color:rgba(255,255,255,.5)">Fácil:</b> mostra cartas restantes no baralho · <b
              style="color:rgba(255,255,255,.5)">Difícil:</b> sem informação
          </div>
        </div>
        <button class="btn btn-primary" onclick="UI.startGame()">INICIAR PARTIDA →</button>
      </div>
    </div>

    <!-- ══════════════════ SIMPLE GAME ══════════════════ -->
    <div id="screen-simple" class="screen">
      <div class="round-bar">
        <div class="round-label-wrapper">
          <div class="round-label bb">RODADA <span id="s-round-num">1</span></div>
        </div>
        <div class="round-meta-wrapper">
          <span class="badge badge-gold" id="s-meta-badge">META: 200</span>
        </div>
        <div class="toggle-wrapper">
          <div class="input-mode-toggle">
            <div class="imt-btn on" id="imt-manual"
              onclick="Simple.setInputMode('manual');this.classList.add('on');document.getElementById('imt-cards').classList.remove('on');">
              <span>✏️</span><span>Manual</span>
            </div>
            <div class="imt-btn" id="imt-cards"
              onclick="Simple.setInputMode('cards');this.classList.add('on');document.getElementById('imt-manual').classList.remove('on');">
              <span>🃏</span><span>Cartas</span>
            </div>
          </div>
        </div>
      </div>
      <div class="scoreboard-scroll" id="s-scoreboard"></div>
      <div class="game-bottom">
        <button class="btn btn-ghost btn-sm flex-1" onclick="Simple.confirmEnd()">✓ ENCERRAR RODADA</button>
        <button class="btn btn-danger btn-sm" onclick="UI.confirmAbandon()">✕</button>
      </div>
    </div>

    <!-- ══════════════════ DYNAMIC GAME ══════════════════ -->
    <div id="screen-dynamic" class="screen">
      <div class="round-bar">
        <div class="round-label-wrapper">
          <div class="round-label bb">RODADA <span id="d-round-num">1</span></div>
        </div>
        <div class="round-meta-wrapper">
          <span class="badge badge-gold" id="d-meta-badge">META: 200</span>
        </div>
        <div class="toggle-wrapper">
          <div class="input-mode-toggle">
            <div class="imt-btn on" id="d-diff-easy"
              onclick="Dyn.setDynDiff('easy');this.classList.add('on');document.getElementById('d-diff-hard').classList.remove('on');">
              <span>🟢</span><span>Fácil</span>
            </div>
            <div class="imt-btn" id="d-diff-hard"
              onclick="Dyn.setDynDiff('hard');this.classList.add('on');document.getElementById('d-diff-easy').classList.remove('on');">
              <span>🔴</span><span>Difícil</span>
            </div>
          </div>
        </div>
      </div>
      <div class="mini-scores" id="d-mini-scores"></div>
      <div style="height:1px;background:rgba(255,255,255,.06);flex-shrink:0;"></div>

      <!-- Flip Three progress banner -->
      <div id="f3-banner" style="display:none;align-items:center;gap:10px;
    padding:10px 16px;background:linear-gradient(90deg,rgba(62,207,207,.18),rgba(62,207,207,.04));
    border-bottom:1.5px solid rgba(62,207,207,.3);flex-shrink:0;">
        <div style="font-size:20px;">🃏</div>
        <div style="flex:1;">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--teal);letter-spacing:.05em;">FLIP
            THREE</div>
          <div style="font-size:11px;color:rgba(255,255,255,.4);" id="f3b-sub">escolha 3 cartas</div>
        </div>
        <div style="display:flex;gap:5px;">
          <div class="f3b-slot" id="f3b-s0">?</div>
          <div class="f3b-slot" id="f3b-s1">?</div>
          <div class="f3b-slot" id="f3b-s2">?</div>
        </div>
      </div>

      <div class="active-zone" id="d-active-zone" style="overflow-y:auto;flex:1;"></div>

      <!-- inline card picker -->
      <div class="inline-picker" id="d-inline-picker">
        <div class="ip-tabs" id="ip-tabs">
          <div class="ip-tab on" data-tab="num" onclick="Dyn.ipTab('num',this)">Número</div>
          <div class="ip-tab" data-tab="mod" onclick="Dyn.ipTab('mod',this)">Mod</div>
          <div class="ip-tab" data-tab="act" onclick="Dyn.ipTab('act',this)">Ação</div>
        </div>
        <div id="ip-content"></div>
      </div>

      <div class="dyn-bottom">
        <button class="btn btn-stay" id="d-btn-stay" onclick="Dyn.stay()" style="flex:1;">✋ STAY — PARAR</button>
        <button class="btn btn-teal btn-icon" id="d-btn-reload" onclick="Dyn.reloadDeck()" title="Recarregar baralho"
          style="display:none;font-size:16px;">🔄</button>
        <button class="btn btn-danger btn-icon" onclick="UI.confirmAbandon()">✕</button>
      </div>
    </div>

    <!-- ══════════════════ WINNER ══════════════════ -->
    <div id="screen-winner" class="screen">
      <div class="w-trophy">🏆</div>
      <div class="w-label">Vencedor</div>
      <div class="w-name" id="w-name">—</div>
      <div class="w-pts" id="w-pts">—</div>
      <div class="w-table" id="w-table"></div>
      <div class="w-actions">
        <button class="btn btn-primary" onclick="UI.newGame()">NOVA PARTIDA</button>
        <button class="btn btn-ghost btn-sm" onclick="UI.goHome()">Voltar ao início</button>
      </div>
    </div>

  </div><!-- #app -->

  <!-- ══════════════════ MODALS ══════════════════ -->

  <!-- Round confirm -->
  <div class="modal-overlay" id="modal-round">
    <div class="modal-sheet">
      <div class="modal-title">Encerrar Rodada?</div>
      <div id="modal-round-summary" style="display:flex;flex-direction:column;gap:8px;"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost flex-1" onclick="UI.closeModal('modal-round')">Voltar</button>
        <button class="btn btn-primary flex-1" id="modal-round-confirm">CONFIRMAR</button>
      </div>
    </div>
  </div>

  <!-- Abandon -->
  <div class="modal-overlay" id="modal-abandon">
    <div class="modal-sheet">
      <div class="modal-title">Abandonar Partida?</div>
      <p style="color:rgba(255,255,255,.4);font-size:14px;line-height:1.6">
        Todo o progresso será perdido permanentemente.
      </p>
      <div class="modal-actions">
        <button class="btn btn-ghost flex-1" onclick="UI.closeModal('modal-abandon')">Cancelar</button>
        <button class="btn btn-danger flex-1" onclick="UI.abandonGame()">ABANDONAR</button>
      </div>
    </div>
  </div>

  <!-- Card picker -->
  <div class="modal-overlay" id="modal-pick">
    <div class="modal-sheet">
      <div class="pick-title" id="pick-title">Qual carta você tirou?</div>
      <div class="pick-tabs" id="pick-tabs">
        <div class="pick-tab on" data-tab="num" onclick="Dyn.pickTab('num',this)">Número</div>
        <div class="pick-tab" data-tab="mod" onclick="Dyn.pickTab('mod',this)">Modificador</div>
        <div class="pick-tab" data-tab="act" onclick="Dyn.pickTab('act',this)">Ação</div>
      </div>
      <div id="pick-content"></div>
      <button class="btn btn-ghost btn-sm" onclick="UI.closeModal('modal-pick')">Cancelar</button>
    </div>
  </div>

  <!-- Freeze target -->
  <div class="modal-overlay" id="modal-freeze">
    <div class="modal-sheet">
      <div class="modal-title" id="modal-freeze-title">❄️ FREEZE — Congelar quem?</div>
      <p style="color:rgba(255,255,255,.4);font-size:13px;" id="modal-freeze-desc">
        O jogador alvo perde 1 turno.
      </p>
      <div class="freeze-targets" id="freeze-targets"></div>
      <button class="btn btn-ghost btn-sm" onclick="UI.closeModal('modal-freeze')">Cancelar</button>
    </div>
  </div>

  <!-- Edit name -->
  <div class="modal-overlay edit-name-modal" id="modal-edit-name">
    <div class="modal-sheet">
      <div class="modal-title">✏️ Editar Nome</div>
      <input type="text" id="edit-name-input" maxlength="18" placeholder="Nome do jogador"
        onkeydown="if(event.key==='Enter')Edit.confirmName()" />
      <div class="modal-actions">
        <button class="btn btn-ghost flex-1" onclick="UI.closeModal('modal-edit-name')">Cancelar</button>
        <button class="btn btn-primary flex-1" onclick="Edit.confirmName()">SALVAR</button>
      </div>
    </div>
  </div>

  <!-- Remove card -->
  <div class="modal-overlay" id="modal-rm-card">
    <div class="modal-sheet">
      <div class="modal-title" id="rm-card-title">Remover carta?</div>
      <p style="color:rgba(255,255,255,.4);font-size:14px;line-height:1.6" id="rm-card-desc">Remover esta carta da mão
        do jogador.</p>
      <div class="modal-actions">
        <button class="btn btn-ghost flex-1" onclick="UI.closeModal('modal-rm-card')">Cancelar</button>
        <button class="btn btn-danger flex-1" onclick="Edit.confirmRemoveCard()">REMOVER</button>
      </div>
    </div>
  </div>

  <script>
    /* ═══════════════════════════════════════════════════════
       FLIP 7 COMPANION v2 — Modo Simples + Modo Dinâmico
       Arquitetura: módulos G (state), Simple, Dyn, UI
    ═══════════════════════════════════════════════════════ */

    /* ─────────────────────────────────────────
       DECK KNOWLEDGE
    ───────────────────────────────────────── */
    const DECK = (() => {
      // number counts: card N appears N times (except 0 = 1 copy)
      const numCounts = {};
      numCounts[0] = 1;
      for (let n = 1; n <= 12; n++) numCounts[n] = n;

      // modifier counts (1 each per the physical deck)
      const modCounts = { '+2': 1, '+4': 1, '+6': 1, '+8': 1, '+10': 1, 'x2': 1 };

      // action counts
      const actCounts = { 'FREEZE': 3, 'FLIP THREE': 3, 'SECOND CHANCE': 3 };

      return { numCounts, modCounts, actCounts };
    })();

    /* ─────────────────────────────────────────
       G — GLOBAL STATE
    ───────────────────────────────────────── */
    const G = (() => {
      const SAVE = 'flip7_v2';

      let state = {
        mode: 'simple', // 'simple' | 'dynamic'
        players: [],    // { name, avatar }
        meta: 200,
        round: 1,
        screen: 'splash',
        // SIMPLE
        scores: [],          // cumulative
        sRoundInputs: [],    // [{pts,bust}]
        sHistory: [],        // [[{pts,bust}]]
        // DYNAMIC
        // playerStates[i] = {
        //   status: 'active'|'stayed'|'busted'|'frozen',
        //   hand: [{type,value}],   // type: 'num'|'mod'|'action'
        //   hasSecondChance: bool,
        //   roundPts: number,       // running total for this round
        // }
        dPlayerStates: [],
        dCurrentIdx: 0,
        dDeckUsed: {},   // tracks cards played this round for availability hint
      };

      function save() {
        try { localStorage.setItem(SAVE, JSON.stringify(state)); } catch (e) { }
      }
      function load() {
        try {
          const r = localStorage.getItem(SAVE);
          if (r) { const d = JSON.parse(r); Object.assign(state, d); return true; }
        } catch (e) { }
        return false;
      }
      function clear() {
        try { localStorage.removeItem(SAVE); } catch (e) { }
      }

      return { state, save, load, clear };
    })();

    /* ─────────────────────────────────────────
       UTILS
    ───────────────────────────────────────── */
    const AV = ['av-0', 'av-1', 'av-2', 'av-3', 'av-4', 'av-5'];
    const esc = s => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    function calcDynPts(hand) {
      // hand = [{type,value}]
      let sum = 0;
      let mult = 1;
      let bonus = 0;
      hand.forEach(c => {
        if (c.type === 'num') sum += c.value;
        else if (c.type === 'mod') {
          if (c.value === 'x2') mult *= 2;
          else bonus += parseInt(c.value);
        }
      });
      return (sum * mult) + bonus;
    }

    function uniqueNums(hand) {
      return [...new Set(hand.filter(c => c.type === 'num').map(c => c.value))];
    }

    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModalEl(id) { document.getElementById(id).classList.remove('open'); }

    /* ─────────────────────────────────────────
       UI — navigation, shared helpers
    ───────────────────────────────────────── */
    const UI = (() => {

      let selectedMode = 'simple';

      function pickMode(mode, el) {
        selectedMode = mode;
        G.state.mode = mode;
        document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        // bolt animation when dynamic selected
        if (mode === 'dynamic') {
          const bolt = document.getElementById('bolt-icon');
          if (bolt) { bolt.classList.remove('bolt'); void bolt.offsetWidth; bolt.classList.add('bolt'); }
        }
        // show difficulty is now for both modes
        const diffEl = document.getElementById('setup-difficulty');
        if (diffEl) diffEl.style.display = '';
      }

      function setDiff(diff, el) {
        G.state.difficulty = diff;
        document.querySelectorAll('#setup-difficulty .meta-chip').forEach(c => c.classList.remove('on'));
        el.classList.add('on');
      }

      function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        G.state.screen = id;
      }

      function goHome() {
        G.clear();
        Object.assign(G.state, {
          mode: 'simple', players: [], meta: 200, round: 1, screen: 'splash',
          scores: [], sRoundInputs: [], sHistory: [],
          dPlayerStates: [], dCurrentIdx: 0, dDeckUsed: {}
        });
        renderSplash();
        showScreen('splash');
      }

      function backToSplash() { showScreen('splash'); }

      function goSetup() {
        G.state.mode = selectedMode;
        G.state.players = [];
        G.state.meta = 200;
        renderSetup();
        showScreen('setup');
        setTimeout(() => { addPlayer(); addPlayer(); }, 50);
      }

      function continueGame() {
        if (G.state.screen === 'winner') { renderWinner(); showScreen('winner'); }
        else if (G.state.mode === 'dynamic') { Dyn.render(); showScreen('dynamic'); }
        else { Simple.render(); showScreen('simple'); }
      }

      function renderSplash() {
        const has = G.load();
        document.getElementById('btn-continue').style.display = has ? '' : 'none';
        // reset mode UI
        document.querySelectorAll('.mode-card').forEach(c => {
          c.classList.toggle('selected', c.dataset.mode === G.state.mode);
        });
        selectedMode = G.state.mode || 'simple';
      }

      function renderSetup() {
        const m = G.state.mode;
        document.getElementById('smb-icon').textContent = m === 'dynamic' ? '⚡' : '📝';
        document.getElementById('smb-name').textContent = m === 'dynamic' ? 'MODO DINÂMICO' : 'MODO SIMPLES';
        document.getElementById('smb-desc').textContent = m === 'dynamic'
          ? 'Selecione as cartas · Turno a turno · Cálculo automático'
          : 'Pontuação manual por rodada';
        renderPlayerList();
        // reset meta chips
        document.querySelectorAll('.meta-chip').forEach(c => {
          c.classList.toggle('on', c.dataset.v === '200');
        });
        G.state.meta = 200;
        document.getElementById('custom-meta').style.display = 'none';
      }

      function renderPlayerList() {
        const list = document.getElementById('player-list');
        list.innerHTML = '';
        G.state.players.forEach((p, i) => {
          const row = document.createElement('div');
          row.className = 'player-row';
          row.draggable = true;
          row.dataset.idx = i;
          row.innerHTML = `
        <div class="drag-handle" title="Arrastar para reordenar">
          <span></span><span></span><span></span>
        </div>
        <span class="p-num">${i + 1}</span>
        <input type="text" placeholder="Nome do jogador" value="${esc(p.name)}"
          oninput="UI.updateName(${i},this.value)" maxlength="18"/>
        ${G.state.players.length > 2 ? `<button class="btn btn-icon btn-danger"
          onclick="UI.removePlayer(${i})" style="font-size:13px">✕</button>` : ''}
      `;
          // drag events
          row.addEventListener('dragstart', e => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', i);
            row.classList.add('dragging');
          });
          row.addEventListener('dragend', () => row.classList.remove('dragging'));
          row.addEventListener('dragover', e => { e.preventDefault(); row.classList.add('drag-over'); });
          row.addEventListener('dragleave', () => row.classList.remove('drag-over'));
          row.addEventListener('drop', e => {
            e.preventDefault(); row.classList.remove('drag-over');
            const from = parseInt(e.dataTransfer.getData('text/plain'));
            const to = i;
            if (from === to) return;
            const arr = G.state.players;
            const moved = arr.splice(from, 1)[0];
            arr.splice(to, 0, moved);
            renderPlayerList();
          });
          list.appendChild(row);
        });
        document.getElementById('add-player-btn').style.display =
          G.state.players.length >= 6 ? 'none' : '';
      }

      function addPlayer() {
        if (G.state.players.length >= 6) return;
        G.state.players.push({ name: '', avatar: AV[G.state.players.length % 6] });
        renderPlayerList();
        setTimeout(() => {
          const ins = document.querySelectorAll('.player-row input');
          if (ins.length) ins[ins.length - 1].focus();
        }, 80);
      }

      function updateName(i, v) { G.state.players[i].name = v; }
      function removePlayer(i) { G.state.players.splice(i, 1); renderPlayerList(); }

      function setMeta(v, el) {
        document.querySelectorAll('.meta-chip').forEach(c => c.classList.remove('on'));
        el.classList.add('on');
        const cw = document.getElementById('custom-meta');
        if (v === 'c') {
          cw.style.display = '';
          G.state.meta = parseInt(document.getElementById('custom-meta-val').value) || 200;
        } else {
          cw.style.display = 'none';
          G.state.meta = v;
        }
      }

      function startGame() {
        const named = G.state.players.filter(p => p.name.trim() !== '');
        if (named.length < 2) { alert('Adicione pelo menos 2 jogadores com nome!'); return; }
        G.state.players = named;

        if (G.state.mode === 'dynamic') {
          Dyn.initGame();
        } else {
          Simple.initGame();
        }
      }

      function closeModal(id) { closeModalEl(id); }

      function confirmAbandon() { openModal('modal-abandon'); }
      function abandonGame() {
        closeModalEl('modal-abandon');
        stopConfetti();
        goHome();
      }

      function newGame() {
        stopConfetti();
        G.clear();
        G.state.players = [];
        G.state.meta = 200;
        renderSetup();
        showScreen('setup');
        setTimeout(() => { addPlayer(); addPlayer(); }, 50);
      }

      function renderWinner() {
        const scores = G.state.scores;
        const max = Math.max(...scores);
        const wi = scores.indexOf(max);
        document.getElementById('w-name').textContent = G.state.players[wi].name;
        document.getElementById('w-pts').textContent = max + ' pts';
        const sorted = G.state.players
          .map((p, i) => ({ name: p.name, score: scores[i] }))
          .sort((a, b) => b.score - a.score);
        const medals = ['🥇', '🥈', '🥉'];
        document.getElementById('w-table').innerHTML = sorted.map((p, i) => `
      <div class="w-row">
        <span class="w-rank">${medals[i] || i + 1 + 'º'}</span>
        <span class="w-rname">${esc(p.name)}</span>
        <span class="w-rpts">${p.score}</span>
      </div>`).join('');
      }

      function triggerWinner() {
        G.save();
        renderWinner();
        showScreen('winner');
        launchConfetti();
      }

      return {
        pickMode, showScreen, goHome, backToSplash, goSetup, continueGame,
        renderSplash, renderSetup, renderPlayerList,
        addPlayer, updateName, removePlayer, setMeta, setDiff,
        startGame, closeModal, confirmAbandon, abandonGame, newGame,
        renderWinner, triggerWinner,
      };
    })();

    /* ─────────────────────────────────────────
       SIMPLE — Modo Simples
    ───────────────────────────────────────── */
    const Simple = (() => {

      // 'manual' | 'cards'
      // stored per-game in G.state.sInputMode
      function initGame() {
        const s = G.state;
        s.round = 1;
        s.scores = s.players.map(() => 0);
        s.sHistory = s.players.map(() => []);
        s.sInputMode = s.sInputMode || 'manual';
        initRound();
        G.save();
        render();
        UI.showScreen('simple');
      }

      function initRound() {
        const s = G.state;
        s.sRoundInputs = s.players.map(() => ({
          pts: 0, bust: false,
          hand: [],      // [{type,value}] for card mode
          sDeckUsed: {}, // deck tracking per player in simple card mode
        }));
      }

      function render() {
        const s = G.state;
        document.getElementById('s-round-num').textContent = s.round;
        document.getElementById('s-meta-badge').textContent = 'META: ' + s.meta;
        renderBoard();
      }

      function renderBoard() {
        const s = G.state; const board = document.getElementById('s-scoreboard');
        board.innerHTML = '';
        const maxS = Math.max(...s.scores);
        s.players.forEach((p, i) => {
          const ri = s.sRoundInputs[i], tot = s.scores[i];
          const pct = Math.min(100, Math.round(tot / s.meta * 100));
          const lead = tot === maxS && tot > 0, near = tot >= s.meta * .75;
          const hist = s.sHistory[i];
          const isCards = s.sInputMode === 'cards';
          const hand = ri.hand || [];
          const curPts = isCards ? calcDynPts(hand) : ri.pts;
          const nums = uniqueNums(hand);

          const c = document.createElement('div');
          c.className = 'ssc' + (lead ? ' leading' : near ? ' near' : '');

          // build hand HTML for card mode
          let handHtml = '';
          if (isCards && hand.length > 0) {
            handHtml = `<div class="s-hand">
          ${hand.map((cd, ci) => `<div class="s-hand-card ${cd.type === 'mod' ? 'mod' : ''}"
            onclick="Edit.openRemoveCard(${i},${ci},'simple')" title="Toque para remover">
            ${cd.type === 'num' ? cd.value : cd.value}</div>`).join('')}
        </div>`;
          }

          // build input area
          let inputHtml = '';
          if (isCards) {
            // card grid picker for this player
            const used = ri.sDeckUsed || {};
            const easy = s.difficulty !== 'hard';
            // numbers
            let numGrid = '<div class="s-pick-grid">';
            [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].forEach(n => {
              const max = DECK.numCounts[n];
              const usedC = (used['num:' + n] || 0);
              const rem = max - usedC;
              const rep = nums.includes(n);
              const isGone = rem <= 0;
              const cls = easy ? (isGone ? 'gone' : rep ? 'rep' : '') : (rep ? 'rep' : '');
              const clickable = easy ? !isGone : true;
              numGrid += `<div class="spc ${cls}"
            onclick="${clickable ? `Simple.pickNum(${i},${n})` : ''}">
            ${n}${easy ? `<span class="sc-cnt">${rem}</span>` : ''}
          </div>`;
            });
            numGrid += '</div>';
            // mods
            let modGrid = '<div class="s-pick-mod-grid">';
            ['+2', '+4', '+6', '+8', '+10', 'x2'].forEach(m => {
              const usedC = used['mod:' + m] || 0;
              const isGone = usedC >= 1;
              const cls = easy ? (isGone ? 'gone' : '') : '';
              const clickable = easy ? !isGone : true;
              modGrid += `<div class="spm ${cls}"
            onclick="${clickable ? `Simple.pickMod(${i},'${m}')` : ''}">${m}</div>`;
            });
            modGrid += '</div>';
            inputHtml = `
          <div style="padding:8px 14px 12px;border-top:1px solid rgba(255,255,255,.05);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
              <span class="ssc-lbl">Cartas desta rodada</span>
              ${hand.length > 0 ? `<button onclick="Simple.clearHand(${i})"
                style="font-size:11px;color:rgba(255,255,255,.3);background:none;border:none;cursor:pointer;">limpar</button>`: ''}
            </div>
            ${handHtml}
            ${numGrid}
            <div style="margin-top:5px;">${modGrid}</div>
          </div>`;
          } else {
            inputHtml = `
          <div class="ssc-input">
            <div class="ssc-row">
              <span class="ssc-lbl">Rodada:</span>
              <div class="step-btn" onclick="Simple.step(${i},-1)">−</div>
              <input class="num-input" type="number" id="si-${i}" value="${ri.pts}"
                oninput="Simple.setPts(${i},this.value)" inputmode="numeric" min="0"/>
              <div class="step-btn" onclick="Simple.step(${i},1)">＋</div>
            </div>
          </div>`;
          }

          c.innerHTML = `
        <div class="ssc-top">
          <div class="ssc-av ${p.avatar}">${p.name.slice(0, 2).toUpperCase()}</div>
          <div class="ssc-name">${esc(p.name)}</div>
          <button class="edit-name-btn" onclick="Edit.openEditName(${i})" title="Editar nome">✏️</button>
          ${lead && maxS > 0 ? '<span class="badge badge-gold" style="font-size:10px">LÍDER</span>' : ''}
          <div class="ssc-total">${tot}${isCards && curPts > 0 ? `<span style="font-size:14px;color:rgba(255,255,255,.3);margin-left:4px;">+${ri.bust ? 0 : curPts}</span>` : ''}</div>
        </div>
        <div class="ssc-bar"><div class="ssc-fill ${near ? 'danger' : ''}" style="width:${pct}%"></div></div>
        ${inputHtml}
        ${hist.length ? `<div class="hist-row">
          ${hist.map(h => {
            const isBust = h.bust || h.pts === 0;
            return `<span class="hc ${isBust ? 'bust' : h.flip7 ? 'flip7' : ''}">${isBust ? 'BUST' : h.flip7 ? '★' + h.pts : h.pts}</span>`;
          }).join('')}
        </div>`: ''}
      `;
          board.appendChild(c);
        });
      }

      /* ── card mode picks ── */
      function pickNum(i, n) {
        const ri = G.state.sRoundInputs[i];
        const nums = uniqueNums(ri.hand);
        if (nums.includes(n)) {
          // repeated — auto-mark bust
          ri.bust = true;
        } else {
          ri.hand.push({ type: 'num', value: n });
          ri.sDeckUsed['num:' + n] = (ri.sDeckUsed['num:' + n] || 0) + 1;
          ri.pts = calcDynPts(ri.hand);
        }
        renderBoard();
      }
      function pickMod(i, m) {
        const ri = G.state.sRoundInputs[i];
        ri.hand.push({ type: 'mod', value: m });
        ri.sDeckUsed['mod:' + m] = (ri.sDeckUsed['mod:' + m] || 0) + 1;
        ri.pts = calcDynPts(ri.hand);
        renderBoard();
      }
      function clearHand(i) {
        const ri = G.state.sRoundInputs[i];
        ri.hand = []; ri.sDeckUsed = {}; ri.pts = 0; ri.bust = false;
        renderBoard();
      }

      /* ── manual mode ── */
      function setPts(i, v) {
        const n = parseInt(v); G.state.sRoundInputs[i].pts = isNaN(n) ? 0 : Math.max(0, n);
        if (G.state.sRoundInputs[i].pts > 0) { G.state.sRoundInputs[i].bust = false; updBust(i); }
      }
      function step(i, d) {
        const cur = G.state.sRoundInputs[i].pts || 0, nv = Math.max(0, cur + d);
        G.state.sRoundInputs[i].pts = nv;
        const el = document.getElementById('si-' + i); if (el) el.value = nv;
        if (nv > 0 && G.state.sRoundInputs[i].bust) { G.state.sRoundInputs[i].bust = false; updBust(i); }
      }
      function toggleBust(i) {
        G.state.sRoundInputs[i].bust = !G.state.sRoundInputs[i].bust;
        if (G.state.sRoundInputs[i].bust) {
          G.state.sRoundInputs[i].pts = 0;
          const el = document.getElementById('si-' + i); if (el) el.value = 0;
        }
        updBust(i);
      }
      function updBust(i) {
        const el = document.getElementById('sb-' + i); if (!el) return;
        const ri = G.state.sRoundInputs[i];
        el.className = 'bust-row ' + (ri.bust ? 'on' : '');
        el.querySelector('.bust-box').textContent = ri.bust ? '✕' : '';
      }

      function setInputMode(mode) {
        G.state.sInputMode = mode;
        renderBoard();
      }

      function confirmEnd() {
        const s = G.state;
        const sum = document.getElementById('modal-round-summary');
        sum.innerHTML = '';
        s.players.forEach((p, i) => {
          const ri = s.sRoundInputs[i];
          const isCards = s.sInputMode === 'cards';
          let pts = isCards ? calcDynPts(ri.hand) : (ri.pts || 0);
          let isBust = ri.bust || (!isCards && pts === 0) || (isCards && pts === 0 && ri.hand.length > 0 && uniqueNums(ri.hand).some(n => ri.sDeckUsed['num:' + n] > 1));

          if (!isCards && pts === 0) {
            isBust = true;
          }

          const row = document.createElement('div');
          row.className = 'summary-row';
          row.innerHTML = `<span class="sum-name">${esc(p.name)}</span>
        <span class="sum-pts ${isBust ? 'bust' : pts === 0 ? 'zero' : ''}">${isBust ? 'BUST' : '+' + pts}</span>`;
          sum.appendChild(row);
        });
        document.getElementById('modal-round-confirm').onclick = applyRound;
        openModal('modal-round');
      }

      function applyRound() {
        closeModalEl('modal-round');
        const s = G.state;
        s.players.forEach((p, i) => {
          const ri = s.sRoundInputs[i];
          const earned = ri.bust ? 0 : (s.sInputMode === 'cards' ? calcDynPts(ri.hand) : ri.pts || 0);
          s.scores[i] += earned;
          s.sHistory[i].push({ pts: earned, bust: ri.bust });
        });
        if (Math.max(...s.scores) >= s.meta) { UI.triggerWinner(); return; }
        s.round++;
        initRound();
        G.save();
        render();
        document.getElementById('s-scoreboard').scrollTop = 0;
      }

      return {
        initGame, render, renderBoard,
        pickNum, pickMod, clearHand,
        setPts, step, toggleBust, setInputMode,
        confirmEnd, applyRound
      };
    })();

    /* ─────────────────────────────────────────
       DYN — Modo Dinâmico
    ───────────────────────────────────────── */
    const Dyn = (() => {

      let _ipTab = 'num';
      // Flip Three state
      let _f3playerIdx = -1;
      let _f3fromIdx = -1;
      let _f3cards = [];
      let _f3remaining = 0;
      let _f3busted = false;
      let _f3active = false;

      /* ── INIT ──────────────────────────────── */
      function initGame() {
        const s = G.state;
        s.round = 1;
        s.scores = s.players.map(() => 0);
        s.sHistory = s.players.map(() => []);
        initRound();
        G.save();
        render();
        UI.showScreen('dynamic');
      }

      function initRound() {
        const s = G.state;
        s.dCurrentIdx = 0;
        s.dDeckUsed = {};
        s.dPlayerStates = s.players.map(() => ({
          status: 'active', hand: [], hasSecondChance: false, roundPts: 0,
        }));
        // advance to first active (all active at start, so idx=0)
        s.dCurrentIdx = 0;
      }

      function advanceToNextActive(from) {
        const s = G.state; const n = s.players.length;
        for (let i = 1; i <= n; i++) {
          const idx = (from + i) % n;
          if (s.dPlayerStates[idx].status === 'active') { s.dCurrentIdx = idx; return true; }
        }
        return false;
      }

      function setDynDiff(diff) {
        G.state.difficulty = diff;
        G.save();
        render(); // Re-render to show/hide the deck count logic
      }

      /* ── RENDER ────────────────────────────── */
      function render() {
        // Update header details
        const s = G.state;
        const rn = document.getElementById('d-round-num');
        if (rn) rn.textContent = s.round;
        const mb = document.getElementById('d-meta-badge');
        if (mb) mb.textContent = 'META: ' + s.meta;

        // Sync custom toggle visual logic directly from G state initialization
        const dde = document.getElementById('d-diff-easy');
        const ddh = document.getElementById('d-diff-hard');
        if (dde && ddh) {
          if (s.difficulty === 'hard') {
            ddh.classList.add('on'); dde.classList.remove('on');
          } else {
            dde.classList.add('on'); ddh.classList.remove('on');
          }
        }

        renderMiniScores();
        renderActiveZone();
        renderInlinePicker();
        checkRoundEnd();
      }

      function renderMiniScores() {
        const s = G.state;
        const strip = document.getElementById('d-mini-scores');
        strip.innerHTML = '';
        s.players.forEach((p, i) => {
          const ps = s.dPlayerStates[i];
          const isCur = i === s.dCurrentIdx;
          const icons = { stayed: '✓', busted: '💥', frozen: '❄️', active: '' };
          const div = document.createElement('div');
          div.className = 'mini-player ' + ps.status + (isCur ? ' active-turn' : '');
          div.innerHTML = `
        <div class="mini-av ${p.avatar}">${p.name.slice(0, 2).toUpperCase()}</div>
        <div class="mini-name">${esc(p.name)}</div>
        <div class="mini-score">${s.scores[i]}</div>
        ${icons[ps.status] ? `<div class="mini-status">${icons[ps.status]}</div>` : ''}
      `;
          strip.appendChild(div);
        });
      }

      function renderActiveZone() {
        const s = G.state;
        const zone = document.getElementById('d-active-zone');
        const p = s.players[s.dCurrentIdx];
        const ps = s.dPlayerStates[s.dCurrentIdx];
        const curPts = calcDynPts(ps.hand);
        const nums = uniqueNums(ps.hand);
        const isActive = ps.status === 'active';

        // hand chips — with remove-on-tap
        const curIdx = s.dCurrentIdx;
        const handHtml = ps.hand.map((c, ci) => {
          const rmAttr = `onclick="Edit.openRemoveCard(${curIdx},${ci},'dyn')" title="Toque para remover"`;
          if (c.type === 'num') return `<div class="hand-card ${c.value === 0 ? 'num-zero' : 'num'}" ${rmAttr}>${c.value}</div>`;
          if (c.type === 'mod') return `<div class="hand-card mod ${c.value === 'x2' ? 'x2' : ''}" ${rmAttr}>${c.value}</div>`;
          if (c.type === 'action' && c.value === 'SECOND CHANCE') return `<div class="hand-card sc" ${rmAttr}>2ª CHANCE</div>`;
          return '';
        }).join('');

        // stay button visibility
        const stayBtn = document.getElementById('d-btn-stay');
        const canStay = isActive && nums.length >= 1;
        if (stayBtn) { stayBtn.style.opacity = canStay ? '1' : '.3'; stayBtn.style.pointerEvents = canStay ? '' : 'none'; }

        const picker = document.getElementById('d-inline-picker');
        if (picker) picker.style.display = isActive ? '' : 'none';

        zone.innerHTML = `
      <div class="turn-header">
        <div class="turn-av ${p.avatar}">${p.name.slice(0, 2).toUpperCase()}</div>
        <div class="turn-name">${esc(p.name)}</div>
        <button class="edit-name-btn" onclick="Edit.openEditName(${s.dCurrentIdx})" title="Editar nome">✏️</button>
        <div class="turn-pts">${curPts}</div>
      </div>
      ${ps.hasSecondChance ? `<div class="sc-indicator">
        <div class="sc-icon">💚</div>
        <div class="sc-text">Segunda Chance ativa</div>
      </div>`: ''}
      <div class="section-lbl">
        Mão: ${nums.length}/7 números${nums.length >= 5 ? ` · <span style="color:var(--teal)">${7 - nums.length} para FLIP 7!</span>` : ''}
      </div>
      <div class="hand-area">
        ${ps.hand.length === 0 ? '<span style="font-size:13px;color:rgba(255,255,255,.2)">Selecione uma carta abaixo</span>' : handHtml}
      </div>
      ${!isActive ? `<div style="padding:14px 0;text-align:center;">
        <span class="badge ${ps.status === 'busted' ? 'badge-red' : ps.status === 'frozen' ? 'badge-teal' : 'badge-green'}"
          style="font-size:14px;padding:8px 20px;">
          ${ps.status === 'busted' ? '💥 ESTOUROU' : ps.status === 'frozen' ? '❄️ CONGELADO' : '✓ PAROU — ' + curPts + ' pts'}
        </span>
      </div>`: ''}
      <div style="flex:1;"></div>
    `;
      }

      /* ── INLINE PICKER ─────────────────────── */
      function renderInlinePicker() {
        const s = G.state;
        const ps = s.dPlayerStates[s.dCurrentIdx];
        if (ps.status !== 'active') return;

        // Sync tabs logically and visually
        document.querySelectorAll('.ip-tab').forEach(t => {
          t.classList.toggle('on', t.dataset.tab === _ipTab);
        });

        renderIpContent(_ipTab);
      }

      function ipTab(tab, el) {
        _ipTab = tab;
        document.querySelectorAll('.ip-tab').forEach(t => t.classList.remove('on'));
        el.classList.add('on');
        renderIpContent(tab);
      }

      function renderIpContent(tab) {
        const s = G.state;
        const ps = s.dPlayerStates[s.dCurrentIdx];
        const used = s.dDeckUsed;
        const content = document.getElementById('ip-content');
        if (!content) return;
        const nums = uniqueNums(ps.hand);
        const easy = s.difficulty !== 'hard'; // default is easy

        if (tab === 'num') {
          let html = '<div class="ip-grid-nums">';
          [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].forEach(n => {
            const max = DECK.numCounts[n];
            const usedC = used['num:' + n] || 0;
            const rem = max - usedC;
            const rep = nums.includes(n);
            const isGone = rem <= 0;
            // hard mode: não mostra gone nem contador
            const cls = easy ? (isGone ? 'gone' : rep ? 'rep' : '') : (rep ? 'rep' : '');
            const clickable = easy ? !isGone : true;
            html += `<div class="ip-card ${cls}"
          onclick="${clickable ? `Dyn.selectCard({type:'num',value:${n}})` : ''}">
          ${n}${easy ? `<span class="cnt">${rem}</span>` : ''}
        </div>`;
          });
          html += '</div>';
          content.innerHTML = html;
        } else if (tab === 'mod') {
          let html = '<div class="ip-grid-mods">';
          ['+2', '+4', '+6', '+8', '+10', 'x2'].forEach(m => {
            const gone = (used['mod:' + m] || 0) >= 1;
            const cls = easy ? (gone ? 'gone' : '') : '';
            const clickable = easy ? !gone : true;
            html += `<div class="ip-mod ${m === 'x2' ? 'x2' : ''} ${cls}"
          onclick="${clickable ? `Dyn.selectCard({type:'mod',value:'${m}'})` : ''}">
          ${m}
        </div>`;
          });
          html += '</div>';
          content.innerHTML = html;
        } else if (tab === 'act') {
          const acts = [
            { v: 'FREEZE', icon: '❄️' },
            { v: 'FLIP THREE', icon: '🃏' },
            { v: 'SECOND CHANCE', icon: '💚' },
          ];
          let html = '<div class="ip-grid-acts">';
          acts.forEach(a => {
            const gone = (used['action:' + a.v] || 0) >= DECK.actCounts[a.v];
            const cls = easy ? (gone ? 'gone' : '') : '';
            const clickable = easy ? !gone : true;
            const label = a.v === 'SECOND CHANCE' ? '2ª CHANCE' : a.v;
            html += `<div class="ip-act ${cls}"
          onclick="${clickable ? `Dyn.selectCard({type:'action',value:'${a.v}'})` : ''}">
          <div class="ia-icon">${a.icon}</div>
          <div class="ia-name">${label}</div>
        </div>`;
          });
          html += '</div>';
          content.innerHTML = html;
        }

        // show reload button only in easy mode
        const reloadBtn = document.getElementById('d-btn-reload');
        if (reloadBtn) reloadBtn.style.display = easy ? '' : 'none';
      }

      function reloadDeck() {
        // reset deck tracking — cartas descartadas voltam ao baralho
        G.state.dDeckUsed = {};
        G.save();
        renderIpContent(_ipTab);
        // brief visual feedback
        const btn = document.getElementById('d-btn-reload');
        if (btn) {
          btn.style.transform = 'rotate(360deg)'; btn.style.transition = 'transform .4s';
          setTimeout(() => { btn.style.transform = ''; btn.style.transition = ''; }, 450);
        }
      }

      /* ── SELECT CARD (main entry point) ────── */
      function selectCard(card) {
        if (_f3active) resolveFlip3Card(card);
        else resolveCard(card);
      }

      /* ── STAY ──────────────────────────────── */
      function stay() {
        const s = G.state;
        const ps = s.dPlayerStates[s.dCurrentIdx];
        if (ps.status !== 'active') return;

        // Cannot stay without buying at least one numeric card
        const nums = uniqueNums(ps.hand);
        if (nums.length < 1) return;

        ps.status = 'stayed';
        _ipTab = 'num'; // reset tab for next player
        const found = advanceToNextActive(s.dCurrentIdx);
        G.save();
        render();
        if (!found) checkRoundEnd();
      }

      /* ── CARD RESOLUTION ───────────────────── */
      function resolveCard(card) {
        const s = G.state;
        const i = s.dCurrentIdx;
        const ps = s.dPlayerStates[i];
        if (ps.status !== 'active') return;

        // track deck usage
        const key = card.type + ':' + card.value;
        s.dDeckUsed[key] = (s.dDeckUsed[key] || 0) + 1;

        if (card.type === 'num') {
          const nums = uniqueNums(ps.hand);
          const repeated = nums.includes(card.value);
          if (repeated) {
            if (ps.hasSecondChance) {
              ps.hasSecondChance = false;
              ps.hand = ps.hand.filter(c => !(c.type === 'action' && c.value === 'SECOND CHANCE'));
              // segunda chance consumida → passa para o próximo
              _ipTab = 'num';
              const scFound = advanceToNextActive(i);
              G.save(); render();
              if (!scFound) checkRoundEnd();
              return;
            }
            bustPlayer(i, card.value);
            return;
          }
          ps.hand.push(card);
          if (uniqueNums(ps.hand).length >= 7) {
            ps.status = 'stayed';
            G.save(); render();
            showFlip7(i);
            return;
          }
        } else if (card.type === 'mod') {
          ps.hand.push(card);
        } else if (card.type === 'action') {
          if (card.value === 'FREEZE') { resolveFreeze(i); return; }
          if (card.value === 'FLIP THREE') { resolveFlipThreeTarget(i); return; }
          if (card.value === 'SECOND CHANCE') {
            ps.hasSecondChance = true;
            ps.hand.push({ type: 'action', value: 'SECOND CHANCE' });
          }
        }

        // After any card (except bust/flip7/action that redirects):
        // advance to next active player
        _ipTab = 'num';
        const found = advanceToNextActive(i);
        G.save();
        render();
        if (!found) checkRoundEnd();
      }

      /* ── BUST ──────────────────────────────── */
      function bustPlayer(i, triggerCard) {
        const s = G.state;
        s.dPlayerStates[i].status = 'busted';
        document.getElementById('bust-player-name').textContent = s.players[i].name.toUpperCase();
        document.getElementById('bust-card-info').textContent = `Tirou o número ${triggerCard} novamente`;
        document.getElementById('bust-overlay').classList.add('open');
        if (navigator.vibrate) navigator.vibrate([60, 40, 120]);
        G.save();
      }

      function dismissBust() {
        document.getElementById('bust-overlay').classList.remove('open');
        const s = G.state;
        _ipTab = 'num';
        const found = advanceToNextActive(s.dCurrentIdx);
        G.save();
        render();
        if (!found) checkRoundEnd();
      }

      /* ── FLIP 7 ────────────────────────────── */
      function showFlip7(i) {
        document.getElementById('f7-player-name').textContent = G.state.players[i].name.toUpperCase();
        document.getElementById('flip7-overlay').classList.add('open');
        launchConfetti();
      }

      function dismissFlip7() {
        document.getElementById('flip7-overlay').classList.remove('open');
        stopConfetti();
        const s = G.state;
        s.dPlayerStates.forEach(ps => { if (ps.status === 'active') ps.status = 'stayed'; });
        showRoundEndModal();
      }

      function resolveFreeze(fromIdx) {
        const s = G.state;
        // Get all players but flag if they are active
        const targets = s.players.map((p, i) => ({ p, i, active: s.dPlayerStates[i].status === 'active', status: s.dPlayerStates[i].status }));

        const fList = document.getElementById('freeze-targets');
        fList.innerHTML = '';
        targets.forEach(({ p, i, active, status }) => {
          const el = document.createElement('div');
          el.className = 'freeze-target';
          if (!active) el.style.opacity = '0.5';
          if (!active) el.style.pointerEvents = 'none';

          let badgeHtml = '';
          if (status === 'busted') badgeHtml = `<span class="badge badge-red" style="margin-left:8px;">BUST</span>`;
          else if (status === 'stayed') badgeHtml = `<span class="badge badge-gold" style="margin-left:8px;">PAROU</span>`;

          el.innerHTML = `
        <div class="ft-av ${p.avatar}">${p.name.slice(0, 2).toUpperCase()}</div>
        <div class="ft-name">${esc(p.name)}${badgeHtml}</div>
        <div class="ft-pts">${s.scores[i]} pts</div>
      `;
          if (active) el.onclick = () => applyFreeze(fromIdx, i);
          fList.appendChild(el);
        });
        document.querySelector('#modal-freeze .modal-title').textContent = '❄️ FREEZE — Congelar quem?';
        document.querySelector('#modal-freeze p').textContent = 'O jogador alvo perde 1 turno.';
        openModal('modal-freeze');
      }

      function applyFreeze(fromIdx, targetIdx) {
        closeModalEl('modal-freeze');
        const s = G.state;
        s.dPlayerStates[targetIdx].status = 'frozen';
        s.dPlayerStates[targetIdx].frozenTurns = 1; // Only skip 1 turn
        _ipTab = 'num';
        // advance from fromIdx (the player who played freeze, not the target)
        // if target===from, that player is now frozen so advanceToNextActive skips them
        const found = advanceToNextActive(fromIdx);
        G.save();
        render();
        if (!found) checkRoundEnd();
      }

      /* ── FLIP THREE ────────────────────────── */
      function resolveFlipThreeTarget(fromIdx) {
        // First: choose who will draw 3 cards (can be self or others)
        const s = G.state;
        const fList = document.getElementById('freeze-targets');
        fList.innerHTML = '';

        // All active players (including self) can be targeted
        s.players.forEach((p, i) => {
          const active = s.dPlayerStates[i].status === 'active';
          const status = s.dPlayerStates[i].status;

          const el = document.createElement('div');
          el.className = 'freeze-target';
          if (!active) el.style.opacity = '0.5';
          if (!active) el.style.pointerEvents = 'none';

          let badgeHtml = '';
          if (status === 'busted') badgeHtml = `<span class="badge badge-red" style="margin-left:8px;">BUST</span>`;
          else if (status === 'stayed') badgeHtml = `<span class="badge badge-gold" style="margin-left:8px;">PAROU</span>`;

          el.innerHTML = `
        <div class="ft-av ${p.avatar}">${p.name.slice(0, 2).toUpperCase()}</div>
        <div class="ft-name">${esc(p.name)}${i === fromIdx ? ' (você)' : ''}${badgeHtml}</div>
        <div class="ft-pts">${s.scores[i]} pts</div>
      `;
          if (active) el.onclick = () => startFlipThree(fromIdx, i);
          fList.appendChild(el);
        });

        // Repurpose freeze modal title
        document.querySelector('#modal-freeze .modal-title').textContent = '🃏 FLIP THREE — Quem compra?';
        document.querySelector('#modal-freeze p').textContent = 'O alvo deve comprar 3 cartas na sequência.';
        openModal('modal-freeze');
      }

      function startFlipThree(fromIdx, targetIdx) {
        closeModalEl('modal-freeze');
        document.querySelector('#modal-freeze .modal-title').textContent = '❄️ FREEZE — Congelar quem?';

        _f3playerIdx = targetIdx;
        _f3fromIdx = fromIdx;
        _f3cards = [];
        _f3remaining = 3;
        _f3busted = false;
        _f3active = true;

        G.state.dCurrentIdx = targetIdx;

        // Show banner
        const banner = document.getElementById('f3-banner');
        banner.style.display = 'flex';
        banner.style.animation = 'cardPop .25s cubic-bezier(.22,1,.36,1)';
        document.getElementById('f3b-sub').textContent =
          G.state.players[targetIdx].name + ' — selecione 3 cartas';
        ['f3b-s0', 'f3b-s1', 'f3b-s2'].forEach(id => {
          const el = document.getElementById(id);
          el.textContent = '?'; el.className = 'f3b-slot';
        });

        _ipTab = 'num';
        G.save();
        render();
      }

      /* resolveFlip3Card — called by selectCard when _f3active */
      function resolveFlip3Card(card) {
        if (!_f3active || _f3remaining <= 0 || _f3busted) return;
        const ci = 3 - _f3remaining;
        const s = G.state;
        const i = _f3playerIdx;
        const ps = s.dPlayerStates[i];

        const key = card.type + ':' + card.value;
        s.dDeckUsed[key] = (s.dDeckUsed[key] || 0) + 1;

        const slotEl = document.getElementById('f3b-s' + ci);
        const label = card.type === 'num' ? String(card.value) :
          card.type === 'mod' ? card.value : '2ªCH';

        if (card.type === 'num') {
          const nums = uniqueNums(ps.hand);
          if (nums.includes(card.value)) {
            if (ps.hasSecondChance) {
              ps.hasSecondChance = false;
              ps.hand = ps.hand.filter(c => !(c.type === 'action' && c.value === 'SECOND CHANCE'));
              slotEl.textContent = label; slotEl.className = 'f3b-slot done';
              _f3remaining--;
            } else {
              slotEl.textContent = 'BUST'; slotEl.className = 'f3b-slot bust';
              _f3busted = true; _f3remaining = 0;
            }
          } else {
            ps.hand.push(card);
            slotEl.textContent = label; slotEl.className = 'f3b-slot done';
            _f3remaining--;
            if (uniqueNums(ps.hand).length >= 7) _f3remaining = 0;
          }
        } else if (card.type === 'mod') {
          ps.hand.push(card);
          slotEl.textContent = label; slotEl.className = 'f3b-slot done';
          _f3remaining--;
        } else {
          slotEl.textContent = label; slotEl.className = 'f3b-slot done';
          _f3remaining--;
        }

        // Re-render hand and picker without advancing turn
        G.save();
        renderMiniScores();
        renderActiveZone();
        renderIpContent(_ipTab);

        if (_f3remaining <= 0 || _f3busted) {
          setTimeout(() => endFlip3(), 500);
        }
      }

      function endFlip3() {
        _f3active = false;
        document.getElementById('f3-banner').style.display = 'none';

        const s = G.state;
        const i = _f3playerIdx;
        const ps = s.dPlayerStates[i];

        if (_f3busted) { bustPlayer(i, 'repetido'); return; }
        if (uniqueNums(ps.hand).length >= 7) {
          ps.status = 'stayed'; G.save(); render(); showFlip7(i); return;
        }
        _ipTab = 'num';
        const found = advanceToNextActive(i);
        G.save(); render();
        if (!found) checkRoundEnd();
      }

      /* ── PICKER MODAL (for flip3 — legacy, kept for modal-pick only) ── */
      let _pickCallback = null;
      function openPickerModal(title, callback) {
        _pickCallback = callback;
        document.getElementById('pick-title').textContent = title;
        document.querySelectorAll('.pick-tab').forEach(t => {
          t.classList.toggle('on', t.dataset.tab === 'num');
        });
        renderPickContent('num');
        openModal('modal-pick');
      }
      function pickFlip3Card() { /* legacy stub — no longer used */ }

      function renderPickContent(tab) {
        const s = G.state;
        const ps = s.dPlayerStates[_f3playerIdx >= 0 ? _f3playerIdx : s.dCurrentIdx];
        const used = s.dDeckUsed;
        const content = document.getElementById('pick-content');
        if (!content) return;
        const nums = uniqueNums(ps.hand);

        if (tab === 'num') {
          let html = '<div class="pick-grid">';
          [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].forEach(n => {
            const max = DECK.numCounts[n]; const usedC = used['num:' + n] || 0;
            const rem = max - usedC; const rep = nums.includes(n);
            html += `<div class="pick-card ${rem <= 0 ? 'taken' : rep ? 'highlight' : 'available'}"
          onclick="${rem <= 0 ? '' : ('Dyn.modalSelectCard({type:\'num\',value:' + n + '})')}">
          ${n}<span class="card-count">${rem}/${max}</span>
        </div>`;
          });
          html += '</div>';
          content.innerHTML = html;
        } else if (tab === 'mod') {
          let html = '<div class="pick-mod-grid">';
          ['+2', '+4', '+6', '+8', '+10', 'x2'].forEach(m => {
            const gone = (used['mod:' + m] || 0) >= 1;
            html += `<div class="pick-mod ${m === 'x2' ? 'x2' : ''} ${gone ? 'taken' : ''}"
          onclick="${gone ? '' : ('Dyn.modalSelectCard({type:\'mod\',value:\'' + m + '\'})')}">
          ${m}</div>`;
          });
          html += '</div>';
          content.innerHTML = html;
        } else if (tab === 'act') {
          const acts = [
            { v: 'FREEZE', icon: '🔒', desc: 'Congela outro jogador ativo' },
            { v: 'FLIP THREE', icon: '🃏', desc: 'Obriga 3 compras' },
            { v: 'SECOND CHANCE', icon: '💚', desc: 'Ignora próximo número repetido' },
          ];
          let html = '<div class="pick-action-grid">';
          acts.forEach(a => {
            const gone = (used['action:' + a.v] || 0) >= DECK.actCounts[a.v];
            html += `<div class="pick-action ${gone ? 'taken' : ''}"
          onclick="${gone ? '' : ('Dyn.modalSelectCard({type:\'action\',value:\'' + a.v + '\'})')}">
          <div class="pa-icon">${a.icon}</div>
          <div class="pa-info">
            <div class="pa-name">${a.v}</div>
            <div class="pa-desc">${a.desc}</div>
          </div>
        </div>`;
          });
          html += '</div>';
          content.innerHTML = html;
        }
      }

      function pickTab(tab, el) {
        document.querySelectorAll('.pick-tab').forEach(t => t.classList.remove('on'));
        el.classList.add('on');
        renderPickContent(tab);
      }

      function modalSelectCard(card) {
        closeModalEl('modal-pick');
        if (_pickCallback) { _pickCallback(card); _pickCallback = null; }
      }

      /* ── ROUND END ─────────────────────────── */
      function checkRoundEnd() {
        const s = G.state;
        const allDone = s.dPlayerStates.every(ps => ps.status !== 'active');
        if (allDone) setTimeout(() => showRoundEndModal(), 350);
      }

      function showRoundEndModal() {
        const s = G.state;
        const sum = document.getElementById('modal-round-summary');
        sum.innerHTML = '';
        s.players.forEach((p, i) => {
          const ps = s.dPlayerStates[i];
          const pts = ps.status === 'busted' ? 0 : calcDynPts(ps.hand);
          const row = document.createElement('div');
          row.className = 'summary-row';
          row.innerHTML = `
        <div class="flex-row">
          <div style="width:26px;height:26px;border-radius:99px;display:flex;
            align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;
            font-size:12px;" class="${p.avatar}">${p.name.slice(0, 2).toUpperCase()}</div>
          <span class="sum-name">${esc(p.name)}</span>
          ${ps.status === 'frozen' ? '<span class="badge badge-teal" style="font-size:9px">❄️</span>' : ''}
        </div>
        <span class="sum-pts ${ps.status === 'busted' ? 'bust' : pts === 0 ? 'zero' : ''}">${ps.status === 'busted' ? 'BUST' : '+' + pts}</span>
      `;
          sum.appendChild(row);
        });
        document.getElementById('modal-round-confirm').onclick = applyDynRound;
        openModal('modal-round');
      }

      function applyDynRound() {
        closeModalEl('modal-round');
        const s = G.state;
        s.players.forEach((p, i) => {
          const ps = s.dPlayerStates[i];
          const pts = ps.status === 'busted' ? 0 : calcDynPts(ps.hand);
          const isFlip7 = uniqueNums(ps.hand).length >= 7;
          s.scores[i] += pts + (isFlip7 ? 15 : 0);
          s.sHistory[i].push({ pts, bust: ps.status === 'busted', flip7: isFlip7 });
        });
        if (Math.max(...s.scores) >= s.meta) { UI.triggerWinner(); return; }
        s.round++;
        _f3playerIdx = -1;
        _ipTab = 'num';
        initRound();
        G.save();
        render();
      }

      return {
        initGame, render, stay,
        ipTab, selectCard, reloadDeck,
        dismissBust, showFlip7, dismissFlip7,
        applyFreeze, pickFlip3Card, modalSelectCard,
        pickTab, setDynDiff,
      };
    })();

    /* ─────────────────────────────────────────
       EDIT — name, card removal, player order
    ───────────────────────────────────────── */
    const Edit = (() => {
      let _editPlayerIdx = -1;
      let _rmPlayerIdx = -1;
      let _rmCardIdx = -1;
      let _rmMode = 'dyn'; // 'dyn' | 'simple'

      /* ── NAME EDITING ─────────────────────── */
      function openEditName(playerIdx) {
        _editPlayerIdx = playerIdx;
        const inp = document.getElementById('edit-name-input');
        inp.value = G.state.players[playerIdx].name;
        openModal('modal-edit-name');
        setTimeout(() => inp.focus(), 80);
      }

      function confirmName() {
        const val = document.getElementById('edit-name-input').value.trim();
        if (!val) return;
        G.state.players[_editPlayerIdx].name = val;
        closeModalEl('modal-edit-name');
        G.save();
        // Re-render whichever screen is active
        const s = G.state.screen;
        if (s === 'simple') Simple.renderBoard();
        if (s === 'dynamic') Dyn.render();
      }

      /* ── CARD REMOVAL ─────────────────────── */
      function openRemoveCard(playerIdx, cardIdx, mode) {
        _rmPlayerIdx = playerIdx;
        _rmCardIdx = cardIdx;
        _rmMode = mode;
        const s = G.state;
        const card = mode === 'simple'
          ? s.sRoundInputs[playerIdx].hand[cardIdx]
          : s.dPlayerStates[playerIdx].hand[cardIdx];
        const label = card.type === 'num' ? 'Número ' + card.value
          : card.type === 'mod' ? 'Modificador ' + card.value
            : card.value;
        document.getElementById('rm-card-title').textContent = 'Remover ' + label + '?';
        document.getElementById('rm-card-desc').textContent =
          'A carta será removida da mão de ' + s.players[playerIdx].name + '.';
        openModal('modal-rm-card');
      }

      function confirmRemoveCard() {
        const s = G.state;
        closeModalEl('modal-rm-card');
        if (_rmMode === 'simple') {
          const ri = s.sRoundInputs[_rmPlayerIdx];
          const removed = ri.hand.splice(_rmCardIdx, 1)[0];
          // un-track from sDeckUsed
          if (removed) {
            const key = removed.type + ':' + removed.value;
            if (ri.sDeckUsed[key]) ri.sDeckUsed[key] = Math.max(0, ri.sDeckUsed[key] - 1);
          }
          ri.pts = calcDynPts(ri.hand);
          ri.bust = false;
          G.save();
          Simple.renderBoard();
        } else {
          const ps = s.dPlayerStates[_rmPlayerIdx];
          const removed = ps.hand.splice(_rmCardIdx, 1)[0];
          // un-track deck usage
          if (removed) {
            const key = removed.type + ':' + removed.value;
            if (s.dDeckUsed[key]) s.dDeckUsed[key] = Math.max(0, s.dDeckUsed[key] - 1);
            // if second chance card removed, also clear flag
            if (removed.type === 'action' && removed.value === 'SECOND CHANCE')
              ps.hasSecondChance = false;
          }
          G.save();
          Dyn.render();
        }
      }

      return { openEditName, confirmName, openRemoveCard, confirmRemoveCard };
    })();

    /* ─────────────────────────────────────────
       CONFETTI
    ───────────────────────────────────────── */
    const COLORS = ['#F5C842', '#E8394A', '#3ECFCF', '#5CBD6A', '#4A7BD4', '#FDF6E3'];
    let _confettiRaf = null;

    function launchConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth; canvas.height = window.innerHeight;
      const P = Array.from({ length: 100 }, () => ({
        x: Math.random() * canvas.width, y: Math.random() * -canvas.height * .5,
        w: 5 + Math.random() * 8, h: 3 + Math.random() * 6,
        color: COLORS[Math.floor(Math.random() * COLORS.length)],
        vx: (Math.random() - .5) * 3.5, vy: 2 + Math.random() * 4,
        rot: Math.random() * 360, vr: (Math.random() - .5) * 7, op: 1
      }));
      let frame = 0;
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        P.forEach(p => {
          p.x += p.vx; p.y += p.vy; p.rot += p.vr;
          if (frame > 80) p.op -= .007;
          ctx.save(); ctx.globalAlpha = Math.max(0, p.op);
          ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
          ctx.fillStyle = p.color; ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          ctx.restore();
        });
        frame++;
        _confettiRaf = requestAnimationFrame(draw);
        if (frame > 240) stopConfetti();
      }
      draw();
    }
    function stopConfetti() {
      if (_confettiRaf) { cancelAnimationFrame(_confettiRaf); _confettiRaf = null; }
      const canvas = document.getElementById('confetti-canvas');
      canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    }

    /* ─────────────────────────────────────────
       INIT
    ───────────────────────────────────────── */
    document.addEventListener('DOMContentLoaded', () => {
      // Registra Service Worker para PWA Offline
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(reg => console.log('SW registrado com sucesso!', reg.scope))
            .catch(err => console.log('Falha ao registrar SW:', err));
        });
      }

      UI.renderSplash();
      // close modals on overlay tap
      document.querySelectorAll('.modal-overlay').forEach(m => {
        m.addEventListener('click', e => {
          if (e.target === m) m.classList.remove('open');
        });
      });
    });
  </script>
</body>

</html>